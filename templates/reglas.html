{% extends 'base.html' %}
{% block title %}Reglas{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Reglas</h2>
<div class="page-tabs">
    <a class="tab-link active" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
</div>
<p>Para reglas de medición usa "*" en <em>Texto del usuario</em> y define la fórmula en <em>Cálculo</em> con variables como <code>medida</code>, <code>p1</code> o <code>p2</code>. El comodín "*" permite avanzar al siguiente paso sin validar el texto recibido: si es la única regla del paso se ejecutará automáticamente; si hay más reglas, actuará como opción por defecto. Opcionalmente indica un <em>Handler</em> para delegar el cálculo a código externo.</p>

<form id="reglaForm" method="POST" enctype="multipart/form-data">
    <h3>Agregar o actualizar regla</h3>
    <input type="hidden" id="regla_id" name="regla_id">
    <label for="step">Paso actual:</label>
    <input type="text" id="step" name="step" required>

    <label for="input_text">Texto del usuario (separa sinónimos con comas):</label>
    <input type="text" id="input_text" name="input_text" placeholder="palabra1, palabra2" required>

    <label for="respuesta">Respuesta del bot:</label>
    <textarea id="respuesta" name="respuesta" rows="4"></textarea>

    <label for="siguiente_step">Siguiente paso (puedes ingresar varios pasos separados por comas):</label>
    <input type="text" id="siguiente_step" name="siguiente_step" placeholder="paso1, paso2">

    <label for="platform">Plataforma:</label>
    <select name="platform" id="platform" class="form-control">
        <option value="">Todas</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="messenger">Messenger</option>
        <option value="instagram">Instagram</option>
    </select>

    <label for="tipo">Tipo:</label>
    <select name="tipo" id="tipo" class="form-control">
        <option value="texto">Texto</option>
        <option value="boton">Botón</option>
        <option value="lista">Lista</option>
        <option value="flow">Flow</option>
        <option value="image">Imagen</option>
        <option value="document">Documento</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
    </select>
    <p id="instagram-rule-warning" class="alert alert-warning" style="display:none;">
        Instagram solo acepta reglas de tipo texto o botón.
    </p>

    <label for="media" id="label_media_file" style="display:none;">Subir archivo:</label>
    <input type="file" id="media" name="media[]" multiple style="display:none;">

    <label for="media_url" id="label_media_url" style="display:none;">URLs de archivos (separadas por comas o saltos de línea):</label>
    <textarea id="media_url" name="media_url" style="display:none;" placeholder="URL1, URL2&#10;URL3"></textarea>

    <label for="rol_keyword">Rol keyword:</label>
    <select id="rol_keyword" name="rol_keyword">
        <option value="">Sin rol</option>
        {% for role in roles %}
        <option value="{{ role.keyword }}">{{ role.name }} ({{ role.keyword }})</option>
        {% endfor %}
    </select>

    <label for="calculo">Cálculo:</label>
    <input type="text" id="calculo" name="calculo">

    <label for="handler">Handler externo:</label>
    <input type="text" id="handler" name="handler">

    <label for="active_schedule_preset">Horario activo (solo para IA):</label>
    <select id="active_schedule_preset" class="form-control">
        <option value="custom">Personalizado</option>
        <option value="nights">Noches (17:30-07:30)</option>
        <option value="all_day">Todo el día (00:00-23:59)</option>
        <option value="business_hours">Horario laboral (08:00-18:00)</option>
    </select>
    <div class="schedule-row">
        <div class="schedule-field">
            <label for="active_start_time">Desde:</label>
            <input type="time" id="active_start_time">
        </div>
        <div class="schedule-field">
            <label for="active_end_time">Hasta:</label>
            <input type="time" id="active_end_time">
        </div>
    </div>
    <div class="schedule-days">
        <span class="helper-text">Días activos:</span>
        <label><input type="checkbox" class="active-day" value="lun"> Lun</label>
        <label><input type="checkbox" class="active-day" value="mar"> Mar</label>
        <label><input type="checkbox" class="active-day" value="mie"> Mié</label>
        <label><input type="checkbox" class="active-day" value="jue"> Jue</label>
        <label><input type="checkbox" class="active-day" value="vie"> Vie</label>
        <label><input type="checkbox" class="active-day" value="sab"> Sáb</label>
        <label><input type="checkbox" class="active-day" value="dom"> Dom</label>
        <button type="button" class="btn-secondary btn-xs" id="schedule_days_all">Todos</button>
        <button type="button" class="btn-secondary btn-xs" id="schedule_days_weekdays">Lun-Vie</button>
        <button type="button" class="btn-secondary btn-xs" id="schedule_days_weekend">Sáb-Dom</button>
        <button type="button" class="btn-secondary btn-xs" id="schedule_days_clear">Limpiar</button>
    </div>
    <small class="helper-text">
        Si dejas horas o días vacíos, no se limitará la regla por ese criterio.
    </small>
    <input type="hidden" id="active_hours" name="active_hours">
    <input type="hidden" id="active_days" name="active_days">

    <label for="list_header" class="list-field" style="display:none;">Encabezado de la lista:</label>
    <input type="text" id="list_header" name="list_header" class="list-field" style="display:none;">

    <label for="list_button" class="list-field" style="display:none;">Texto del botón:</label>
    <input type="text" id="list_button" name="list_button" class="list-field" style="display:none;">

    <label for="list_footer" class="list-field" style="display:none;">Pie de página (opcional):</label>
    <input type="text" id="list_footer" name="list_footer" class="list-field" style="display:none;">

    <div id="button_builder" class="button-field" style="display:none;">
        <label>Opciones del botón:</label>
        <div id="button_builder_list" class="builder-list"></div>
        <button type="button" class="btn-secondary" id="add_button_option">Agregar botón</button>
        <p id="button-platform-hint" class="helper-text" style="display:none;">
            En WhatsApp solo se permiten botones de respuesta.
        </p>
    </div>
    <textarea id="button_options" name="button_options" class="button-field" style="display:none;"></textarea>
    <div id="instagram-button-help" class="alert alert-info" style="display:none;">
        <strong>Instagram:</strong> usa un arreglo JSON con hasta 3 botones. Puedes enviar botones de respuesta
        (<code>type: "postback"</code> con <code>title</code> y <code>payload</code>) o botones de enlace
        (<code>type: "web_url"</code> con <code>title</code> y <code>url</code>).
        <pre class="rule-pre">[
  {"type": "postback", "title": "Ver catálogo", "payload": "catalogo"},
  {"type": "web_url", "title": "Ir al sitio", "url": "https://tusitio.com"}
]</pre>
    </div>
    <div id="messenger-button-help" class="alert alert-info" style="display:none;">
        <strong>Messenger:</strong> usa hasta 3 botones. Tipos soportados: <code>postback</code>,
        <code>web_url</code>, <code>phone_number</code>, <code>account_link</code>,
        <code>account_unlink</code> y <code>game_play</code>.
        <pre class="rule-pre">[
  {"type": "postback", "title": "Ver catálogo", "payload": "catalogo"},
  {"type": "web_url", "title": "Ir al sitio", "url": "https://tusitio.com"},
  {"type": "phone_number", "title": "Llamar", "phone_number": "+15105559999"},
  {"type": "account_link", "url": "https://tusitio.com/login"},
  {"type": "account_unlink"},
  {"type": "game_play", "title": "Jugar", "payload": "{\"level\":1}"}
]</pre>
    </div>

    <div id="list_builder" class="list-field" style="display:none;">
        <label>Secciones de la lista:</label>
        <div id="sections_builder" class="builder-list"></div>
        <button type="button" class="btn-secondary" id="add_list_section">Agregar sección</button>
    </div>
    <textarea id="sections" name="sections" class="list-field" style="display:none;"></textarea>

    <div id="flow_fields" class="flow-field" style="display:none;">
        <h4>Configuración de Flow</h4>
        <label for="flow_cta">CTA:</label>
        <input type="text" id="flow_cta" name="flow_cta" placeholder="Ej. flow_cta">

        <label for="flow_id">ID del Flow:</label>
        <input type="text" id="flow_id" name="flow_id" placeholder="flow_id">

        <label for="flow_name">Nombre del Flow:</label>
        <input type="text" id="flow_name" name="flow_name" placeholder="Nombre legible">

        <label for="flow_version">Versión:</label>
        <input type="text" id="flow_version" name="flow_version" placeholder="Ej. 1.0">

        <label for="flow_mode">Modo:</label>
        <input type="text" id="flow_mode" name="flow_mode" placeholder="Ej. draft o live">

        <label for="flow_token">Token:</label>
        <input type="text" id="flow_token" name="flow_token" placeholder="Token opcional">

        <label for="flow_action">Acción:</label>
        <input type="text" id="flow_action" name="flow_action" placeholder="Acción del flow">

        <label for="flow_initial_screen">Pantalla inicial:</label>
        <input type="text" id="flow_initial_screen" name="flow_initial_screen" placeholder="ID de pantalla inicial">

        <label for="flow_data">Datos (JSON o texto):</label>
        <textarea id="flow_data" name="flow_data" rows="4" placeholder='{"variable":"valor"}'></textarea>

        <label for="flow_header">Encabezado (opcional):</label>
        <input type="text" id="flow_header" name="flow_header" placeholder="Encabezado del mensaje">

        <label for="flow_body">Cuerpo (opcional):</label>
        <textarea id="flow_body" name="flow_body" rows="3" placeholder="Descripción para el Flow"></textarea>

        <label for="flow_footer">Pie (opcional):</label>
        <input type="text" id="flow_footer" name="flow_footer" placeholder="Texto de pie">
    </div>
    <input type="hidden" name="opciones" id="opciones">

    <button type="submit" class="btn-primary">Guardar regla</button>
</form>

<form method="POST" enctype="multipart/form-data">
    <h3>Importar reglas desde archivo Excel (.xlsx)</h3>
    <input type="file" name="archivo" accept=".xlsx" required>
    <button type="submit" class="btn-primary">Importar reglas</button>
</form>

<h3>Estados de chat</h3>
<p>Define los estados automáticos del chat y sus colores para la lista de conversaciones.</p>
<form id="chatStateForm" method="POST" action="{{ url_for('configuracion.save_chat_state_definition') }}">
    <input type="hidden" id="original_key" name="original_key">
    <label for="state_key">Key:</label>
    <input type="text" id="state_key" name="state_key" placeholder="ej. esperando_respuesta" required>

    <label for="state_label">Etiqueta visible:</label>
    <input type="text" id="state_label" name="label" placeholder="Esperando respuesta">

    <label for="state_color">Color:</label>
    <input type="color" id="state_color" name="color_hex" value="#666666">

    <label for="state_text_color">Color de texto:</label>
    <input type="color" id="state_text_color" name="text_color_hex" value="#ffffff">

    <label for="state_priority">Prioridad:</label>
    <input type="number" id="state_priority" name="priority" value="0">

    <label class="checkbox-field" for="state_visible">
        <input type="checkbox" id="state_visible" name="visible" checked>
        Visible en la UI
    </label>

    <button type="submit" class="btn-primary">Guardar estado</button>
</form>

<div class="state-grid">
    {% for estado in chat_state_definitions %}
    <details class="state-card">
        <summary>
            <span class="state-color-dot" style="background-color: {{ estado.color }};"></span>
            <div class="rule-summary-text">
                <span><strong>{{ estado.label }}</strong></span>
                <span class="muted-text">{{ estado.key }}</span>
            </div>
        </summary>
        <div class="rule-content">
            <dl class="rule-fields">
                <div class="rule-field">
                    <dt>Color</dt>
                    <dd>{{ estado.color }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Color texto</dt>
                    <dd>{{ estado.text_color }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Prioridad</dt>
                    <dd>{{ estado.priority }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Visible</dt>
                    <dd>{{ 'Sí' if estado.visible else 'No' }}</dd>
                </div>
            </dl>
            <div class="rule-actions">
                <form onsubmit="event.preventDefault();">
                    <button class="edit-btn btn-primary" type="button" onclick='cargarEstadoChat({{ estado|tojson }})'>Editar</button>
                </form>
                <form method="POST" action="{{ url_for('configuracion.delete_chat_state_definition') }}">
                    <input type="hidden" name="state_key" value="{{ estado.key }}">
                    <button class="delete-btn btn-primary" type="submit">Eliminar</button>
                </form>
            </div>
        </div>
    </details>
    {% endfor %}
</div>

<h3>Reglas existentes</h3>
<div class="rules-grid">
    {% for regla in reglas %}
    <details class="rule-card">
        <summary>
            <span class="rule-badge">#{{ regla.id }}</span>
            <div class="rule-summary-text">
                <span><strong>Paso:</strong> {{ regla.step }}</span>
                <span><strong>Entrada:</strong> {{ regla.input_text }}</span>
                <span><strong>Plataforma:</strong> {{ regla.platform or 'Todas' }}</span>
                <span><strong>Tipo:</strong> {{ regla.tipo }}</span>
                <span><strong>Siguiente:</strong> {{ regla.siguiente_step or '-' }}</span>
            </div>
        </summary>
        <div class="rule-content">
            <dl class="rule-fields">
                <div class="rule-field">
                    <dt>Respuesta</dt>
                    <dd>{{ regla.respuesta }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Plataforma</dt>
                    <dd>{{ regla.platform or 'Todas' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Rol</dt>
                    <dd>{{ regla.rol_keyword or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Media URL</dt>
                    <dd>
                        {% if regla.media_urls %}
                            <pre class="rule-pre">{{ regla.media_urls|join('\n') }}</pre>
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="rule-field">
                    <dt>Media tipo</dt>
                    <dd>
                        {% if regla.media_tipos %}
                            <pre class="rule-pre">{{ regla.media_tipos|join('\n') }}</pre>
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="rule-field">
                    <dt>Cálculo</dt>
                    <dd>{{ regla.calculo or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Handler</dt>
                    <dd>{{ regla.handler or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Horario activo</dt>
                    <dd>{{ regla.active_hours or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Días activos</dt>
                    <dd>{{ regla.active_days or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Encabezado</dt>
                    <dd>{{ regla.header or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Botón</dt>
                    <dd>{{ regla.button or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Pie</dt>
                    <dd>{{ regla.footer or '-' }}</dd>
                </div>
                <div class="rule-field rule-field--wide">
                    <dt>Opciones</dt>
                    <dd>
                        {% if regla.tipo == 'flow' and regla.flow %}
                            <div class="flow-block"><strong>CTA:</strong> {{ regla.flow.cta or '-' }}</div>
                            <div class="flow-block"><strong>ID:</strong> {{ regla.flow.flow_id or '-' }}</div>
                            <div class="flow-block"><strong>Nombre:</strong> {{ regla.flow.flow_name or '-' }}</div>
                            <div class="flow-block"><strong>Versión:</strong> {{ regla.flow.version or '-' }}</div>
                            <div class="flow-block"><strong>Modo:</strong> {{ regla.flow.mode or '-' }}</div>
                            <div class="flow-block"><strong>Acción:</strong> {{ regla.flow.action or '-' }}</div>
                            <div class="flow-block"><strong>Pantalla inicial:</strong> {{ regla.flow.initial_screen or '-' }}</div>
                            {% if regla.flow.token %}
                            <div class="flow-block"><strong>Token:</strong> {{ regla.flow.token }}</div>
                            {% endif %}
                            {% if regla.flow.data_display %}
                            <details class="rule-subdetails">
                                <summary>Datos</summary>
                                <pre class="rule-pre">{{ regla.flow.data_display }}</pre>
                            </details>
                            {% endif %}
                            {% if regla.flow.json_display %}
                            <details class="rule-subdetails">
                                <summary>JSON completo</summary>
                                <pre class="rule-pre">{{ regla.flow.json_display }}</pre>
                            </details>
                            {% endif %}
                        {% else %}
                            <pre class="rule-pre">{{ regla.opciones_pretty or regla.opciones or '-' }}</pre>
                        {% endif %}
                    </dd>
                </div>
            </dl>
            <div class="rule-actions">
                <form onsubmit="event.preventDefault();">
                    <button class="edit-btn btn-primary" type="button" onclick='cargarRegla({{ regla|tojson }})'>Editar</button>
                </form>
                <form method="POST" action="{{ url_for('configuracion.eliminar_regla', regla_id=regla.id) }}">
                    <button class="delete-btn btn-primary" type="submit">Eliminar</button>
                </form>
            </div>
        </div>
    </details>
    {% endfor %}
</div>

<script>
function toggleMediaFields() {
    const tipo = document.getElementById('tipo').value;
    const show = ['image', 'video', 'audio', 'document'].includes(tipo);
    const mediaInput = document.getElementById('media');
    const mediaUrl   = document.getElementById('media_url');
    mediaInput.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_file').style.display = show ? 'block' : 'none';
    mediaUrl.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_url').style.display = show ? 'block' : 'none';
    if (!show) {
        mediaInput.value = '';
        mediaUrl.value = '';
    }
}

function toggleListFields() {
    const isList = document.getElementById('tipo').value === 'lista';
    document.querySelectorAll('.list-field').forEach(el => {
        el.style.display = isList ? 'block' : 'none';
    });
}

function toggleButtonFields() {
    const isButton = document.getElementById('tipo').value === 'boton';
    document.querySelectorAll('.button-field').forEach(el => {
        el.style.display = isButton ? 'block' : 'none';
    });
}

function toggleFlowFields() {
    const isFlow = document.getElementById('tipo').value === 'flow';
    document.querySelectorAll('.flow-field').forEach(el => {
        el.style.display = isFlow ? 'block' : 'none';
    });
}

function toggleInstagramButtonHelp() {
    const tipo = document.getElementById('tipo').value;
    const platform = document.getElementById('platform').value;
    const help = document.getElementById('instagram-button-help');
    if (!help) return;
    help.style.display = platform === 'instagram' && tipo === 'boton' ? 'block' : 'none';
}

function toggleMessengerButtonHelp() {
    const tipo = document.getElementById('tipo').value;
    const platform = document.getElementById('platform').value;
    const help = document.getElementById('messenger-button-help');
    if (!help) return;
    help.style.display = platform === 'messenger' && tipo === 'boton' ? 'block' : 'none';
}

function syncButtonTypeOptions() {
    const platform = document.getElementById('platform').value;
    const allowedTypes = (() => {
        if (platform === 'messenger') {
            return ['postback', 'web_url', 'phone_number', 'account_link', 'account_unlink', 'game_play'];
        }
        if (platform === 'instagram') {
            return ['postback', 'web_url'];
        }
        return ['reply'];
    })();
    document.querySelectorAll('.button-type').forEach(select => {
        select.querySelectorAll('option').forEach(option => {
            option.disabled = !allowedTypes.includes(option.value);
        });
        if (!allowedTypes.includes(select.value)) {
            select.value = allowedTypes[0] || 'reply';
            updateButtonRowVisibility(select.closest('.builder-row'));
        }
    });
    const hint = document.getElementById('button-platform-hint');
    if (hint) {
        hint.style.display = platform === '' || platform === 'whatsapp' ? 'block' : 'none';
    }
}

function updateButtonRowVisibility(row) {
    if (!row) return;
    const type = row.querySelector('.button-type')?.value || 'reply';
    const urlField = row.querySelector('.button-url-field');
    const payloadField = row.querySelector('.button-payload-field');
    const phoneField = row.querySelector('.button-phone-field');
    const metadataField = row.querySelector('.button-metadata-field');
    const titleField = row.querySelector('.button-title-field');

    const showUrl = type === 'web_url' || type === 'account_link';
    const showPayload = type === 'reply' || type === 'postback' || type === 'game_play';
    const showPhone = type === 'phone_number';
    const showMetadata = type === 'game_play';
    const showTitle = !['account_link', 'account_unlink'].includes(type);

    if (urlField) urlField.style.display = showUrl ? 'block' : 'none';
    if (payloadField) payloadField.style.display = showPayload ? 'block' : 'none';
    if (phoneField) phoneField.style.display = showPhone ? 'block' : 'none';
    if (metadataField) metadataField.style.display = showMetadata ? 'block' : 'none';
    if (titleField) titleField.style.display = showTitle ? 'block' : 'none';
}

function createButtonRow(data = {}) {
    const row = document.createElement('div');
    row.className = 'builder-row';
    row.innerHTML = `
        <div class="builder-field">
            <label>Tipo</label>
            <select class="button-type">
                <option value="reply">Respuesta</option>
                <option value="postback">Postback</option>
                <option value="web_url">Enlace (URL)</option>
                <option value="phone_number">Llamar</option>
                <option value="account_link">Iniciar sesión</option>
                <option value="account_unlink">Cerrar sesión</option>
                <option value="game_play">Jugar</option>
            </select>
        </div>
        <div class="builder-field button-title-field">
            <label>Título</label>
            <input type="text" class="button-title" placeholder="Texto del botón">
        </div>
        <div class="builder-field button-payload-field">
            <label>ID / Payload</label>
            <input type="text" class="button-payload" placeholder="identificador">
        </div>
        <div class="builder-field button-url-field" style="display:none;">
            <label>URL</label>
            <input type="url" class="button-url" placeholder="https://...">
        </div>
        <div class="builder-field button-phone-field" style="display:none;">
            <label>Teléfono</label>
            <input type="text" class="button-phone" placeholder="+15105559999">
        </div>
        <div class="builder-field button-metadata-field" style="display:none;">
            <label>Game metadata (JSON opcional)</label>
            <input type="text" class="button-metadata" placeholder='{"player_id":"123"}'>
        </div>
        <div class="builder-field">
            <label>Próximo paso (opcional)</label>
            <input type="text" class="button-step" placeholder="siguiente paso">
        </div>
        <div class="builder-actions">
            <button type="button" class="btn-secondary button-remove">Quitar</button>
        </div>
    `;
    row.querySelector('.button-type').value = data.type || 'reply';
    row.querySelector('.button-title').value = data.title || '';
    row.querySelector('.button-payload').value = data.payload || '';
    row.querySelector('.button-url').value = data.url || '';
    row.querySelector('.button-phone').value = data.phone_number || data.phone || '';
    row.querySelector('.button-metadata').value = data.game_metadata || '';
    row.querySelector('.button-step').value = data.step || '';
    row.querySelector('.button-type').addEventListener('change', () => updateButtonRowVisibility(row));
    row.querySelector('.button-remove').addEventListener('click', () => row.remove());
    updateButtonRowVisibility(row);
    return row;
}

function addButtonOption(data = {}) {
    const list = document.getElementById('button_builder_list');
    if (!list) return;
    list.appendChild(createButtonRow(data));
    syncButtonTypeOptions();
}

function createListRow(data = {}) {
    const row = document.createElement('div');
    row.className = 'builder-row';
    row.innerHTML = `
        <div class="builder-field">
            <label>ID</label>
            <input type="text" class="row-id" placeholder="id_opcion">
        </div>
        <div class="builder-field">
            <label>Título</label>
            <input type="text" class="row-title" placeholder="Texto principal">
        </div>
        <div class="builder-field">
            <label>Descripción</label>
            <input type="text" class="row-description" placeholder="Opcional">
        </div>
        <div class="builder-field">
            <label>Próximo paso (opcional)</label>
            <input type="text" class="row-step" placeholder="siguiente paso">
        </div>
        <div class="builder-actions">
            <button type="button" class="btn-secondary row-remove">Quitar</button>
        </div>
    `;
    row.querySelector('.row-id').value = data.id || '';
    row.querySelector('.row-title').value = data.title || '';
    row.querySelector('.row-description').value = data.description || '';
    row.querySelector('.row-step').value = data.step || '';
    row.querySelector('.row-remove').addEventListener('click', () => row.remove());
    return row;
}

function createListSection(data = {}) {
    const section = document.createElement('div');
    section.className = 'builder-section';
    section.innerHTML = `
        <div class="builder-section-header">
            <div class="builder-field">
                <label>Título de sección</label>
                <input type="text" class="section-title" placeholder="Sección">
            </div>
            <div class="builder-actions">
                <button type="button" class="btn-secondary add-row">Agregar fila</button>
                <button type="button" class="btn-secondary remove-section">Quitar sección</button>
            </div>
        </div>
        <div class="section-rows"></div>
    `;
    section.querySelector('.section-title').value = data.title || '';
    const rowsContainer = section.querySelector('.section-rows');
    const rows = Array.isArray(data.rows) ? data.rows : [];
    if (rows.length) {
        rows.forEach(row => rowsContainer.appendChild(createListRow(row)));
    } else {
        rowsContainer.appendChild(createListRow());
    }
    section.querySelector('.add-row').addEventListener('click', () => {
        rowsContainer.appendChild(createListRow());
    });
    section.querySelector('.remove-section').addEventListener('click', () => section.remove());
    return section;
}

function addListSection(data = {}) {
    const list = document.getElementById('sections_builder');
    if (!list) return;
    list.appendChild(createListSection(data));
}

function collectButtons() {
    const rows = Array.from(document.querySelectorAll('#button_builder_list .builder-row'));
    const buttons = [];
    rows.forEach(row => {
        const type = row.querySelector('.button-type')?.value || 'reply';
        const title = row.querySelector('.button-title')?.value.trim();
        const payload = row.querySelector('.button-payload')?.value.trim();
        const url = row.querySelector('.button-url')?.value.trim();
        const phoneNumber = row.querySelector('.button-phone')?.value.trim();
        const metadataRaw = row.querySelector('.button-metadata')?.value.trim();
        const step = row.querySelector('.button-step')?.value.trim();
        if (type === 'web_url') {
            if (!title && !url) return;
            if (!title || !url) {
                throw new Error('Todos los botones de enlace deben tener título y URL.');
            }
            const button = { type: 'web_url', title, url };
            if (step) button.step = step;
            buttons.push(button);
        } else if (type === 'postback') {
            if (!title && !payload) return;
            if (!title || !payload) {
                throw new Error('Todos los botones postback deben tener título e ID.');
            }
            const button = { type: 'postback', title, payload };
            if (step) button.step = step;
            buttons.push(button);
        } else if (type === 'phone_number') {
            if (!title && !phoneNumber) return;
            if (!title || !phoneNumber) {
                throw new Error('Todos los botones de llamada deben tener título y teléfono.');
            }
            const button = { type: 'phone_number', title, phone_number: phoneNumber };
            if (step) button.step = step;
            buttons.push(button);
        } else if (type === 'account_link') {
            if (!url) {
                throw new Error('Los botones de inicio de sesión requieren URL.');
            }
            const button = { type: 'account_link', url };
            if (step) button.step = step;
            buttons.push(button);
        } else if (type === 'account_unlink') {
            const button = { type: 'account_unlink' };
            if (step) button.step = step;
            buttons.push(button);
        } else if (type === 'game_play') {
            if (!title) {
                throw new Error('Los botones de juego requieren título.');
            }
            const button = { type: 'game_play', title };
            if (payload) button.payload = payload;
            if (metadataRaw) {
                try {
                    button.game_metadata = JSON.parse(metadataRaw);
                } catch (err) {
                    throw new Error('El JSON de game_metadata no es válido.');
                }
            }
            if (step) button.step = step;
            buttons.push(button);
        } else {
            if (!title && !payload) return;
            if (!title || !payload) {
                throw new Error('Todos los botones de respuesta deben tener título e ID.');
            }
            const button = { type: 'reply', reply: { id: payload, title } };
            if (step) button.step = step;
            buttons.push(button);
        }
    });
    return buttons;
}

function collectSections() {
    const sections = [];
    document.querySelectorAll('#sections_builder .builder-section').forEach(section => {
        const title = section.querySelector('.section-title')?.value.trim();
        const rows = [];
        section.querySelectorAll('.section-rows .builder-row').forEach(row => {
            const id = row.querySelector('.row-id')?.value.trim();
            const rowTitle = row.querySelector('.row-title')?.value.trim();
            const description = row.querySelector('.row-description')?.value.trim();
            const step = row.querySelector('.row-step')?.value.trim();
            if (!id && !rowTitle && !description && !step) return;
            if (!id || !rowTitle) {
                throw new Error('Todas las filas deben tener ID y título.');
            }
            const rowData = { id, title: rowTitle };
            if (description) rowData.description = description;
            if (step) rowData.step = step;
            rows.push(rowData);
        });
        if (!title && rows.length === 0) return;
        sections.push({ title: title || 'Sección', rows });
    });
    return sections;
}

function prepareOptions(e) {
    const tipo = document.getElementById('tipo').value;
    const opcionesInput = document.getElementById('opciones');
    if (tipo === 'flow') {
        const cta = document.getElementById('flow_cta').value.trim();
        const flowId = document.getElementById('flow_id').value.trim();
        const flowName = document.getElementById('flow_name').value.trim();
        const version = document.getElementById('flow_version').value.trim();
        const mode = document.getElementById('flow_mode').value.trim();
        const token = document.getElementById('flow_token').value.trim();
        const action = document.getElementById('flow_action').value.trim();
        const initialScreen = document.getElementById('flow_initial_screen').value.trim();
        const dataRaw = document.getElementById('flow_data').value.trim();
        const header = document.getElementById('flow_header').value.trim();
        const body = document.getElementById('flow_body').value.trim();
        const footer = document.getElementById('flow_footer').value.trim();

        if (!cta) {
            alert('Debes ingresar el CTA del Flow.');
            e.preventDefault();
            return;
        }
        if (!flowId && !flowName) {
            alert('Debes ingresar el ID o el nombre del Flow.');
            e.preventDefault();
            return;
        }

        let dataValue = undefined;
        if (dataRaw) {
            try {
                dataValue = JSON.parse(dataRaw);
            } catch (err) {
                const looksJson = /^[\[{]/.test(dataRaw);
                if (looksJson) {
                    alert('El JSON de datos del Flow no es válido.');
                    e.preventDefault();
                    return;
                }
                dataValue = dataRaw;
            }
        }

        const flowOptions = { type: 'flow', cta };
        if (flowId) flowOptions.flow_id = flowId;
        if (flowName) flowOptions.flow_name = flowName;
        if (version) flowOptions.version = version;
        if (mode) flowOptions.mode = mode;
        if (token) flowOptions.token = token;
        if (action) flowOptions.action = action;
        if (initialScreen) flowOptions.initial_screen = initialScreen;
        if (dataValue !== undefined && dataValue !== '') flowOptions.data = dataValue;
        if (header) flowOptions.header = header;
        if (body) flowOptions.body = body;
        if (footer) flowOptions.footer = footer;

        opcionesInput.value = JSON.stringify(flowOptions);
    } else if (tipo === 'lista') {
        const header = document.getElementById('list_header').value;
        const button = document.getElementById('list_button').value;
        const footer = document.getElementById('list_footer').value;
        let sections = [];
        try {
            sections = collectSections();
        } catch (err) {
            alert(err.message || 'Hay un error en las secciones de la lista.');
            e.preventDefault();
            return;
        }
        const invalid = !Array.isArray(sections) || sections.length === 0 || sections.some(sec => !sec.rows || sec.rows.length === 0);
        if (invalid) {
            alert('Debes definir al menos una sección con una o más filas.');
            e.preventDefault();
            return;
        }
        document.getElementById('sections').value = JSON.stringify(sections);
        const opts = {header, button, footer, sections};
        opcionesInput.value = JSON.stringify(opts);
    } else if (tipo === 'boton') {
        let botones = [];
        try {
            botones = collectButtons();
        } catch (err) {
            alert(err.message || 'Hay un error en los botones.');
            e.preventDefault();
            return;
        }
        if (!botones.length) {
            alert('Debes agregar al menos un botón.');
            e.preventDefault();
            return;
        }
        document.getElementById('button_options').value = JSON.stringify(botones);
        opcionesInput.value = JSON.stringify(botones);
    } else {
        opcionesInput.value = '';
    }
}
document.getElementById('tipo').addEventListener('change', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    toggleMessengerButtonHelp();
    syncButtonTypeOptions();
});
document.getElementById('platform').addEventListener('change', () => {
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    toggleMessengerButtonHelp();
    syncButtonTypeOptions();
});
const instagramTokenPresent = {{ 'true' if instagram_token_present else 'false' }};
function toggleInstagramWarning() {
    const tipo = document.getElementById('tipo').value;
    const platform = document.getElementById('platform').value;
    const warning = document.getElementById('instagram-rule-warning');
    if (!warning) return;
    const platformApplies = platform === '' || platform === 'instagram';
    const show = instagramTokenPresent && platformApplies && !['texto', 'boton'].includes(tipo);
    warning.style.display = show ? 'block' : 'none';
}
const form = document.getElementById('reglaForm');
form.addEventListener('submit', prepareOptions);
window.addEventListener('DOMContentLoaded', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    toggleMessengerButtonHelp();
    syncButtonTypeOptions();
    const addButton = document.getElementById('add_button_option');
    if (addButton) {
        addButton.addEventListener('click', () => addButtonOption());
    }
    const addSection = document.getElementById('add_list_section');
    if (addSection) {
        addSection.addEventListener('click', () => addListSection());
    }
    if (document.getElementById('button_builder_list')?.children.length === 0) {
        addButtonOption();
    }
    if (document.getElementById('sections_builder')?.children.length === 0) {
        addListSection();
    }
    const presetSelect = document.getElementById('active_schedule_preset');
    if (presetSelect) {
        presetSelect.addEventListener('change', applyPresetSelection);
        document.getElementById('active_start_time')?.addEventListener('input', () => {
            presetSelect.value = 'custom';
            applyPresetSelection();
        });
        document.getElementById('active_end_time')?.addEventListener('input', () => {
            presetSelect.value = 'custom';
            applyPresetSelection();
        });
        document.querySelectorAll('.active-day').forEach(el => {
            el.addEventListener('change', () => {
                updateHiddenScheduleFields();
            });
        });
        document.getElementById('schedule_days_all')?.addEventListener('click', () => {
            setScheduleDays(['lun', 'mar', 'mie', 'jue', 'vie', 'sab', 'dom']);
            updateHiddenScheduleFields();
        });
        document.getElementById('schedule_days_weekdays')?.addEventListener('click', () => {
            setScheduleDays(['lun', 'mar', 'mie', 'jue', 'vie']);
            updateHiddenScheduleFields();
        });
        document.getElementById('schedule_days_weekend')?.addEventListener('click', () => {
            setScheduleDays(['sab', 'dom']);
            updateHiddenScheduleFields();
        });
        document.getElementById('schedule_days_clear')?.addEventListener('click', () => {
            setScheduleDays([]);
            updateHiddenScheduleFields();
        });
        applyPresetSelection();
    }
});

function valueOrEmpty(value, joiner = ', ') {
    if (Array.isArray(value)) {
        return value.filter(item => item !== null && item !== undefined && item !== '').join(joiner);
    }
    if (value === null || value === undefined) {
        return '';
    }
    return String(value);
}

function toPrettyJson(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    if (typeof value === 'string') {
        try {
            const parsed = JSON.parse(value);
            return JSON.stringify(parsed, null, 2);
        } catch (err) {
            return value;
        }
    }
    try {
        return JSON.stringify(value, null, 2);
    } catch (err) {
        return '';
    }
}

const schedulePresets = {
    nights: { start: '17:30', end: '07:30' },
    all_day: { start: '00:00', end: '23:59' },
    business_hours: { start: '08:00', end: '18:00' },
};

function normalizeDayToken(token) {
    const cleaned = (token || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const map = {
        lun: 'lun',
        lunes: 'lun',
        mon: 'lun',
        mar: 'mar',
        martes: 'mar',
        tue: 'mar',
        mie: 'mie',
        miercoles: 'mie',
        miers: 'mie',
        wed: 'mie',
        jue: 'jue',
        jueves: 'jue',
        thu: 'jue',
        vie: 'vie',
        viernes: 'vie',
        fri: 'vie',
        sab: 'sab',
        sabado: 'sab',
        sat: 'sab',
        dom: 'dom',
        domingo: 'dom',
        sun: 'dom',
    };
    return map[cleaned] || cleaned;
}

function parseDayList(value) {
    if (!value) return [];
    return String(value)
        .split(/[,\s;]+/)
        .map(item => normalizeDayToken(item.trim()))
        .filter(Boolean);
}

function parseHoursRange(value) {
    if (!value) return null;
    const firstRange = String(value).split(',')[0];
    const match = firstRange.trim().match(/^(\d{1,2})(?::(\d{2}))?\s*-\s*(\d{1,2})(?::(\d{2}))?$/);
    if (!match) return null;
    const pad = num => String(num).padStart(2, '0');
    const start = `${pad(match[1])}:${pad(match[2] || '00')}`;
    const end = `${pad(match[3])}:${pad(match[4] || '00')}`;
    return { start, end };
}

function updateHiddenScheduleFields() {
    const start = document.getElementById('active_start_time').value;
    const end = document.getElementById('active_end_time').value;
    const days = Array.from(document.querySelectorAll('.active-day:checked')).map(el => el.value);
    document.getElementById('active_hours').value = start && end ? `${start}-${end}` : '';
    document.getElementById('active_days').value = days.join(', ');
}

function setScheduleDays(values) {
    const normalized = new Set(values.map(normalizeDayToken));
    document.querySelectorAll('.active-day').forEach(el => {
        el.checked = normalized.has(el.value);
    });
}

function applyPresetSelection() {
    const preset = document.getElementById('active_schedule_preset').value;
    const startInput = document.getElementById('active_start_time');
    const endInput = document.getElementById('active_end_time');
    if (preset !== 'custom') {
        const presetValue = schedulePresets[preset];
        if (presetValue) {
            startInput.value = presetValue.start;
            endInput.value = presetValue.end;
        }
        startInput.disabled = true;
        endInput.disabled = true;
    } else {
        startInput.disabled = false;
        endInput.disabled = false;
    }
    updateHiddenScheduleFields();
}

function syncScheduleUiFromRule(activeHours, activeDays) {
    const range = parseHoursRange(activeHours);
    if (range) {
        document.getElementById('active_start_time').value = range.start;
        document.getElementById('active_end_time').value = range.end;
    } else {
        document.getElementById('active_start_time').value = '';
        document.getElementById('active_end_time').value = '';
    }
    setScheduleDays(parseDayList(activeDays));
    document.getElementById('active_schedule_preset').value = 'custom';
    applyPresetSelection();
}

function parseOptions(raw) {
    if (!raw && raw !== 0) {
        return undefined;
    }
    if (typeof raw === 'object') {
        return raw;
    }
    if (typeof raw === 'string' && raw.trim() === '') {
        return undefined;
    }
    try {
        return JSON.parse(raw);
    } catch (err) {
        return raw;
    }
}

function cargarRegla(regla) {
    document.getElementById('regla_id').value = regla.id;
    document.getElementById('step').value = valueOrEmpty(regla.step);
    document.getElementById('input_text').value = valueOrEmpty(regla.input_text, ', ');
    document.getElementById('respuesta').value = regla.respuesta || '';
    document.getElementById('siguiente_step').value = valueOrEmpty(regla.siguiente_step);
    document.getElementById('platform').value = regla.platform || '';
    document.getElementById('tipo').value = regla.tipo || 'texto';
    document.getElementById('media').value = '';
    document.getElementById('media_url').value = valueOrEmpty(regla.media_urls, '\n');
    document.getElementById('rol_keyword').value = regla.rol_keyword || '';
    document.getElementById('calculo').value = regla.calculo || '';
    document.getElementById('handler').value = regla.handler || '';
    document.getElementById('active_hours').value = regla.active_hours || '';
    document.getElementById('active_days').value = regla.active_days || '';
    syncScheduleUiFromRule(regla.active_hours, regla.active_days);
    document.getElementById('list_header').value = regla.header || '';
    document.getElementById('list_button').value = regla.button || '';
    document.getElementById('list_footer').value = regla.footer || '';
    document.getElementById('sections').value = '';
    document.getElementById('button_options').value = '';
    document.getElementById('opciones').value = '';
    document.getElementById('flow_cta').value = '';
    document.getElementById('flow_id').value = '';
    document.getElementById('flow_name').value = '';
    document.getElementById('flow_version').value = '';
    document.getElementById('flow_mode').value = '';
    document.getElementById('flow_token').value = '';
    document.getElementById('flow_action').value = '';
    document.getElementById('flow_initial_screen').value = '';
    document.getElementById('flow_data').value = '';
    document.getElementById('flow_header').value = '';
    document.getElementById('flow_body').value = '';
    document.getElementById('flow_footer').value = '';
    const opcionesParsed = parseOptions(regla.opciones);
    if (regla.tipo === 'lista') {
        document.getElementById('sections_builder').innerHTML = '';
        if (opcionesParsed && typeof opcionesParsed === 'object') {
            document.getElementById('list_header').value = opcionesParsed.header || '';
            document.getElementById('list_button').value = opcionesParsed.button || '';
            document.getElementById('list_footer').value = opcionesParsed.footer || '';
            const sections = Array.isArray(opcionesParsed.sections) ? opcionesParsed.sections : [];
            if (sections.length) {
                sections.forEach(section => addListSection({
                    title: section.title || '',
                    rows: Array.isArray(section.rows) ? section.rows : [],
                }));
            } else {
                addListSection();
            }
            document.getElementById('sections').value = JSON.stringify(sections);
            document.getElementById('opciones').value = JSON.stringify(opcionesParsed);
        } else {
            addListSection();
            document.getElementById('sections').value = toPrettyJson(opcionesParsed || '');
            document.getElementById('opciones').value = opcionesParsed || '';
        }
    } else if (regla.tipo === 'boton') {
        document.getElementById('button_builder_list').innerHTML = '';
        const botones = Array.isArray(opcionesParsed) ? opcionesParsed : [];
        if (botones.length) {
            botones.forEach(option => {
                const type = (option.type || '').toLowerCase();
                const reply = option.reply || {};
                const isUrl = type === 'web_url' || option.url || option.link;
                if (isUrl) {
                    addButtonOption({
                        type: 'web_url',
                        title: option.title || option.text || '',
                        url: option.url || option.link || '',
                        step: option.step || option.next_step || '',
                    });
                } else if (type === 'postback') {
                    addButtonOption({
                        type: 'postback',
                        title: option.title || option.text || '',
                        payload: option.payload || option.id || '',
                        step: option.step || option.next_step || '',
                    });
                } else if (type === 'phone_number') {
                    addButtonOption({
                        type: 'phone_number',
                        title: option.title || option.text || '',
                        phone_number: option.phone_number || option.payload || '',
                        step: option.step || option.next_step || '',
                    });
                } else if (type === 'account_link') {
                    addButtonOption({
                        type: 'account_link',
                        url: option.url || option.link || '',
                        step: option.step || option.next_step || '',
                    });
                } else if (type === 'account_unlink') {
                    addButtonOption({
                        type: 'account_unlink',
                        step: option.step || option.next_step || '',
                    });
                } else if (type === 'game_play') {
                    addButtonOption({
                        type: 'game_play',
                        title: option.title || option.text || '',
                        payload: option.payload || '',
                        game_metadata: option.game_metadata ? JSON.stringify(option.game_metadata) : '',
                        step: option.step || option.next_step || '',
                    });
                } else {
                    addButtonOption({
                        type: 'reply',
                        title: option.title || option.text || reply.title || '',
                        payload: option.payload || option.id || reply.id || '',
                        step: option.step || option.next_step || '',
                    });
                }
            });
        } else {
            addButtonOption();
        }
        const normalized = botones.length ? botones : [];
        document.getElementById('button_options').value = toPrettyJson(normalized);
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
    } else if (regla.tipo === 'flow') {
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
        if (regla.flow) {
            document.getElementById('flow_cta').value = regla.flow.cta || '';
            document.getElementById('flow_id').value = regla.flow.flow_id || '';
            document.getElementById('flow_name').value = regla.flow.flow_name || '';
            document.getElementById('flow_version').value = regla.flow.version || '';
            document.getElementById('flow_mode').value = regla.flow.mode || '';
            document.getElementById('flow_token').value = regla.flow.token || '';
            document.getElementById('flow_action').value = regla.flow.action || '';
            document.getElementById('flow_initial_screen').value = regla.flow.initial_screen || '';
            document.getElementById('flow_data').value = toPrettyJson(regla.flow.data_display || regla.flow.data || '');
            document.getElementById('flow_header').value = regla.flow.header || '';
            document.getElementById('flow_body').value = regla.flow.body || '';
            document.getElementById('flow_footer').value = regla.flow.footer || '';
        }
    } else {
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
    }
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramButtonHelp();
    toggleMessengerButtonHelp();
    syncButtonTypeOptions();
}

function cargarEstadoChat(estado) {
    if (!estado) return;
    document.getElementById('original_key').value = estado.key || '';
    document.getElementById('state_key').value = estado.key || '';
    document.getElementById('state_label').value = estado.label || '';
    document.getElementById('state_color').value = estado.color || '#666666';
    document.getElementById('state_text_color').value = estado.text_color || '#ffffff';
    document.getElementById('state_priority').value = estado.priority ?? 0;
    document.getElementById('state_visible').checked = Boolean(estado.visible);
    document.getElementById('state_key').focus();
}
</script>
{% endblock %}
