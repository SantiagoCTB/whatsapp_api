{% extends 'base.html' %}
{% block title %}Reglas{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Reglas</h2>
<div class="page-tabs">
    <a class="tab-link active" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
</div>
<p>Para reglas de medición usa "*" en <em>Texto del usuario</em> y define la fórmula en <em>Cálculo</em> con variables como <code>medida</code>, <code>p1</code> o <code>p2</code>. El comodín "*" permite avanzar al siguiente paso sin validar el texto recibido: si es la única regla del paso se ejecutará automáticamente; si hay más reglas, actuará como opción por defecto. Opcionalmente indica un <em>Handler</em> para delegar el cálculo a código externo.</p>

<form id="reglaForm" method="POST" enctype="multipart/form-data">
    <h3>Agregar o actualizar regla</h3>
    <input type="hidden" id="regla_id" name="regla_id">
    <label for="step">Paso actual:</label>
    <input type="text" id="step" name="step" required>

    <label for="input_text">Texto del usuario (separa sinónimos con comas):</label>
    <input type="text" id="input_text" name="input_text" placeholder="palabra1, palabra2" required>

    <label for="respuesta">Respuesta del bot:</label>
    <textarea id="respuesta" name="respuesta" rows="4"></textarea>

    <label for="siguiente_step">Siguiente paso (puedes ingresar varios pasos separados por comas):</label>
    <input type="text" id="siguiente_step" name="siguiente_step" placeholder="paso1, paso2">

    <label for="tipo">Tipo:</label>
    <select name="tipo" id="tipo" class="form-control">
        <option value="texto">Texto</option>
        <option value="boton">Botón</option>
        <option value="lista">Lista</option>
        <option value="flow">Flow</option>
        <option value="image">Imagen</option>
        <option value="document">Documento</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
    </select>

    <label for="media" id="label_media_file" style="display:none;">Subir archivo:</label>
    <input type="file" id="media" name="media[]" multiple style="display:none;">

    <label for="media_url" id="label_media_url" style="display:none;">URLs de archivos (separadas por comas o saltos de línea):</label>
    <textarea id="media_url" name="media_url" style="display:none;" placeholder="URL1, URL2&#10;URL3"></textarea>

    <label for="rol_keyword">Rol keyword:</label>
    <input type="text" id="rol_keyword" name="rol_keyword">

    <label for="calculo">Cálculo:</label>
    <input type="text" id="calculo" name="calculo">

    <label for="handler">Handler externo:</label>
    <input type="text" id="handler" name="handler">

    <label for="list_header" class="list-field" style="display:none;">Encabezado de la lista:</label>
    <input type="text" id="list_header" name="list_header" class="list-field" style="display:none;">

    <label for="list_button" class="list-field" style="display:none;">Texto del botón:</label>
    <input type="text" id="list_button" name="list_button" class="list-field" style="display:none;">

    <label for="list_footer" class="list-field" style="display:none;">Pie de página (opcional):</label>
    <input type="text" id="list_footer" name="list_footer" class="list-field" style="display:none;">

    <label for="button_options" class="button-field" style="display:none;">Opciones del botón (JSON):</label>
    <textarea id="button_options" name="button_options" class="button-field" style="display:none;" rows="4" cols="60" placeholder='[{"type":"reply","title":"Opción","id":"1"}]'></textarea>

    <label for="sections" class="list-field" style="display:none;">Secciones (formato JSON):</label><br>
    <textarea id="sections" name="sections" class="list-field" style="display:none;" rows="6" cols="60" placeholder='[{"title":"Rápido","rows":[{"id":"express","title":"Express","description":"1 día"}]}]'></textarea>

    <div id="flow_fields" class="flow-field" style="display:none;">
        <h4>Configuración de Flow</h4>
        <label for="flow_cta">CTA:</label>
        <input type="text" id="flow_cta" name="flow_cta" placeholder="Ej. flow_cta">

        <label for="flow_id">ID del Flow:</label>
        <input type="text" id="flow_id" name="flow_id" placeholder="flow_id">

        <label for="flow_name">Nombre del Flow:</label>
        <input type="text" id="flow_name" name="flow_name" placeholder="Nombre legible">

        <label for="flow_version">Versión:</label>
        <input type="text" id="flow_version" name="flow_version" placeholder="Ej. 1.0">

        <label for="flow_mode">Modo:</label>
        <input type="text" id="flow_mode" name="flow_mode" placeholder="Ej. draft o live">

        <label for="flow_token">Token:</label>
        <input type="text" id="flow_token" name="flow_token" placeholder="Token opcional">

        <label for="flow_action">Acción:</label>
        <input type="text" id="flow_action" name="flow_action" placeholder="Acción del flow">

        <label for="flow_initial_screen">Pantalla inicial:</label>
        <input type="text" id="flow_initial_screen" name="flow_initial_screen" placeholder="ID de pantalla inicial">

        <label for="flow_data">Datos (JSON o texto):</label>
        <textarea id="flow_data" name="flow_data" rows="4" placeholder='{"variable":"valor"}'></textarea>

        <label for="flow_header">Encabezado (opcional):</label>
        <input type="text" id="flow_header" name="flow_header" placeholder="Encabezado del mensaje">

        <label for="flow_body">Cuerpo (opcional):</label>
        <textarea id="flow_body" name="flow_body" rows="3" placeholder="Descripción para el Flow"></textarea>

        <label for="flow_footer">Pie (opcional):</label>
        <input type="text" id="flow_footer" name="flow_footer" placeholder="Texto de pie">
    </div>
    <input type="hidden" name="opciones" id="opciones">

    <button type="submit" class="btn-primary">Guardar regla</button>
</form>

<form method="POST" enctype="multipart/form-data">
    <h3>Importar reglas desde archivo Excel (.xlsx)</h3>
    <input type="file" name="archivo" accept=".xlsx" required>
    <button type="submit" class="btn-primary">Importar reglas</button>
</form>

<h3>Reglas existentes</h3>
<div class="rules-grid">
    {% for regla in reglas %}
    <details class="rule-card">
        <summary>
            <span class="rule-badge">#{{ regla.id }}</span>
            <div class="rule-summary-text">
                <span><strong>Paso:</strong> {{ regla.step }}</span>
                <span><strong>Entrada:</strong> {{ regla.input_text }}</span>
                <span><strong>Tipo:</strong> {{ regla.tipo }}</span>
                <span><strong>Siguiente:</strong> {{ regla.siguiente_step or '-' }}</span>
            </div>
        </summary>
        <div class="rule-content">
            <dl class="rule-fields">
                <div class="rule-field">
                    <dt>Respuesta</dt>
                    <dd>{{ regla.respuesta }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Rol</dt>
                    <dd>{{ regla.rol_keyword or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Media URL</dt>
                    <dd>
                        {% if regla.media_urls %}
                            <pre class="rule-pre">{{ regla.media_urls|join('\n') }}</pre>
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="rule-field">
                    <dt>Media tipo</dt>
                    <dd>
                        {% if regla.media_tipos %}
                            <pre class="rule-pre">{{ regla.media_tipos|join('\n') }}</pre>
                        {% else %}
                            -
                        {% endif %}
                    </dd>
                </div>
                <div class="rule-field">
                    <dt>Cálculo</dt>
                    <dd>{{ regla.calculo or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Handler</dt>
                    <dd>{{ regla.handler or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Encabezado</dt>
                    <dd>{{ regla.header or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Botón</dt>
                    <dd>{{ regla.button or '-' }}</dd>
                </div>
                <div class="rule-field">
                    <dt>Pie</dt>
                    <dd>{{ regla.footer or '-' }}</dd>
                </div>
                <div class="rule-field rule-field--wide">
                    <dt>Opciones</dt>
                    <dd>
                        {% if regla.tipo == 'flow' and regla.flow %}
                            <div class="flow-block"><strong>CTA:</strong> {{ regla.flow.cta or '-' }}</div>
                            <div class="flow-block"><strong>ID:</strong> {{ regla.flow.flow_id or '-' }}</div>
                            <div class="flow-block"><strong>Nombre:</strong> {{ regla.flow.flow_name or '-' }}</div>
                            <div class="flow-block"><strong>Versión:</strong> {{ regla.flow.version or '-' }}</div>
                            <div class="flow-block"><strong>Modo:</strong> {{ regla.flow.mode or '-' }}</div>
                            <div class="flow-block"><strong>Acción:</strong> {{ regla.flow.action or '-' }}</div>
                            <div class="flow-block"><strong>Pantalla inicial:</strong> {{ regla.flow.initial_screen or '-' }}</div>
                            {% if regla.flow.token %}
                            <div class="flow-block"><strong>Token:</strong> {{ regla.flow.token }}</div>
                            {% endif %}
                            {% if regla.flow.data_display %}
                            <details class="rule-subdetails">
                                <summary>Datos</summary>
                                <pre class="rule-pre">{{ regla.flow.data_display }}</pre>
                            </details>
                            {% endif %}
                            {% if regla.flow.json_display %}
                            <details class="rule-subdetails">
                                <summary>JSON completo</summary>
                                <pre class="rule-pre">{{ regla.flow.json_display }}</pre>
                            </details>
                            {% endif %}
                        {% else %}
                            <pre class="rule-pre">{{ regla.opciones_pretty or regla.opciones or '-' }}</pre>
                        {% endif %}
                    </dd>
                </div>
            </dl>
            <div class="rule-actions">
                <form onsubmit="event.preventDefault();">
                    <button class="edit-btn btn-primary" type="button" onclick='cargarRegla({{ regla|tojson }})'>Editar</button>
                </form>
                <form method="POST" action="{{ url_for('configuracion.eliminar_regla', regla_id=regla.id) }}">
                    <button class="delete-btn btn-primary" type="submit">Eliminar</button>
                </form>
            </div>
        </div>
    </details>
    {% endfor %}
</div>

<script>
function toggleMediaFields() {
    const tipo = document.getElementById('tipo').value;
    const show = ['image', 'video', 'audio', 'document'].includes(tipo);
    const mediaInput = document.getElementById('media');
    const mediaUrl   = document.getElementById('media_url');
    mediaInput.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_file').style.display = show ? 'block' : 'none';
    mediaUrl.style.display = show ? 'block' : 'none';
    document.getElementById('label_media_url').style.display = show ? 'block' : 'none';
    if (!show) {
        mediaInput.value = '';
        mediaUrl.value = '';
    }
}

function toggleListFields() {
    const isList = document.getElementById('tipo').value === 'lista';
    document.querySelectorAll('.list-field').forEach(el => {
        el.style.display = isList ? 'block' : 'none';
    });
}

function toggleButtonFields() {
    const isButton = document.getElementById('tipo').value === 'boton';
    document.querySelectorAll('.button-field').forEach(el => {
        el.style.display = isButton ? 'block' : 'none';
    });
}

function toggleFlowFields() {
    const isFlow = document.getElementById('tipo').value === 'flow';
    document.querySelectorAll('.flow-field').forEach(el => {
        el.style.display = isFlow ? 'block' : 'none';
    });
}

function prepareOptions(e) {
    const tipo = document.getElementById('tipo').value;
    const opcionesInput = document.getElementById('opciones');
    if (tipo === 'flow') {
        const cta = document.getElementById('flow_cta').value.trim();
        const flowId = document.getElementById('flow_id').value.trim();
        const flowName = document.getElementById('flow_name').value.trim();
        const version = document.getElementById('flow_version').value.trim();
        const mode = document.getElementById('flow_mode').value.trim();
        const token = document.getElementById('flow_token').value.trim();
        const action = document.getElementById('flow_action').value.trim();
        const initialScreen = document.getElementById('flow_initial_screen').value.trim();
        const dataRaw = document.getElementById('flow_data').value.trim();
        const header = document.getElementById('flow_header').value.trim();
        const body = document.getElementById('flow_body').value.trim();
        const footer = document.getElementById('flow_footer').value.trim();

        if (!cta) {
            alert('Debes ingresar el CTA del Flow.');
            e.preventDefault();
            return;
        }
        if (!flowId && !flowName) {
            alert('Debes ingresar el ID o el nombre del Flow.');
            e.preventDefault();
            return;
        }

        let dataValue = undefined;
        if (dataRaw) {
            try {
                dataValue = JSON.parse(dataRaw);
            } catch (err) {
                const looksJson = /^[\[{]/.test(dataRaw);
                if (looksJson) {
                    alert('El JSON de datos del Flow no es válido.');
                    e.preventDefault();
                    return;
                }
                dataValue = dataRaw;
            }
        }

        const flowOptions = { type: 'flow', cta };
        if (flowId) flowOptions.flow_id = flowId;
        if (flowName) flowOptions.flow_name = flowName;
        if (version) flowOptions.version = version;
        if (mode) flowOptions.mode = mode;
        if (token) flowOptions.token = token;
        if (action) flowOptions.action = action;
        if (initialScreen) flowOptions.initial_screen = initialScreen;
        if (dataValue !== undefined && dataValue !== '') flowOptions.data = dataValue;
        if (header) flowOptions.header = header;
        if (body) flowOptions.body = body;
        if (footer) flowOptions.footer = footer;

        opcionesInput.value = JSON.stringify(flowOptions);
    } else if (tipo === 'lista') {
        const header = document.getElementById('list_header').value;
        const button = document.getElementById('list_button').value;
        const footer = document.getElementById('list_footer').value;
        const sectionsText = document.getElementById('sections').value;
        let sections;
        try {
            sections = JSON.parse(sectionsText || '[]');
        } catch (err) {
            sections = [];
        }

        const invalid = !Array.isArray(sections) || sections.length === 0 || sections.some(sec => !sec.rows || sec.rows.length === 0);
        if (invalid) {
            alert('Debes definir al menos una sección con una o más filas.');
            e.preventDefault();
            return;
        }

        const opts = {header, button, footer, sections};
        opcionesInput.value = JSON.stringify(opts);
    } else if (tipo === 'boton') {
        const text = document.getElementById('button_options').value.trim();
        if (text) {
            try {
                JSON.parse(text);
            } catch (err) {
                alert('El JSON de opciones de botón no es válido');
                e.preventDefault();
                return;
            }
        }
        opcionesInput.value = text;
    } else {
        opcionesInput.value = '';
    }
}
document.getElementById('tipo').addEventListener('change', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
});
const form = document.getElementById('reglaForm');
form.addEventListener('submit', prepareOptions);
window.addEventListener('DOMContentLoaded', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
});

function valueOrEmpty(value, joiner = ', ') {
    if (Array.isArray(value)) {
        return value.filter(item => item !== null && item !== undefined && item !== '').join(joiner);
    }
    if (value === null || value === undefined) {
        return '';
    }
    return String(value);
}

function toPrettyJson(value) {
    if (value === null || value === undefined || value === '') {
        return '';
    }
    if (typeof value === 'string') {
        try {
            const parsed = JSON.parse(value);
            return JSON.stringify(parsed, null, 2);
        } catch (err) {
            return value;
        }
    }
    try {
        return JSON.stringify(value, null, 2);
    } catch (err) {
        return '';
    }
}

function parseOptions(raw) {
    if (!raw && raw !== 0) {
        return undefined;
    }
    if (typeof raw === 'object') {
        return raw;
    }
    if (typeof raw === 'string' && raw.trim() === '') {
        return undefined;
    }
    try {
        return JSON.parse(raw);
    } catch (err) {
        return raw;
    }
}

function cargarRegla(regla) {
    document.getElementById('regla_id').value = regla.id;
    document.getElementById('step').value = valueOrEmpty(regla.step);
    document.getElementById('input_text').value = valueOrEmpty(regla.input_text, ', ');
    document.getElementById('respuesta').value = regla.respuesta || '';
    document.getElementById('siguiente_step').value = valueOrEmpty(regla.siguiente_step);
    document.getElementById('tipo').value = regla.tipo || 'texto';
    document.getElementById('media').value = '';
    document.getElementById('media_url').value = valueOrEmpty(regla.media_urls, '\n');
    document.getElementById('rol_keyword').value = regla.rol_keyword || '';
    document.getElementById('calculo').value = regla.calculo || '';
    document.getElementById('handler').value = regla.handler || '';
    document.getElementById('list_header').value = regla.header || '';
    document.getElementById('list_button').value = regla.button || '';
    document.getElementById('list_footer').value = regla.footer || '';
    document.getElementById('sections').value = '';
    document.getElementById('button_options').value = '';
    document.getElementById('opciones').value = '';
    document.getElementById('flow_cta').value = '';
    document.getElementById('flow_id').value = '';
    document.getElementById('flow_name').value = '';
    document.getElementById('flow_version').value = '';
    document.getElementById('flow_mode').value = '';
    document.getElementById('flow_token').value = '';
    document.getElementById('flow_action').value = '';
    document.getElementById('flow_initial_screen').value = '';
    document.getElementById('flow_data').value = '';
    document.getElementById('flow_header').value = '';
    document.getElementById('flow_body').value = '';
    document.getElementById('flow_footer').value = '';
    const opcionesParsed = parseOptions(regla.opciones);
    if (regla.tipo === 'lista') {
        if (opcionesParsed && typeof opcionesParsed === 'object') {
            document.getElementById('list_header').value = opcionesParsed.header || '';
            document.getElementById('list_button').value = opcionesParsed.button || '';
            document.getElementById('list_footer').value = opcionesParsed.footer || '';
            document.getElementById('sections').value = toPrettyJson(opcionesParsed.sections || []);
            document.getElementById('opciones').value = JSON.stringify(opcionesParsed);
        } else {
            document.getElementById('sections').value = toPrettyJson(opcionesParsed || '');
            document.getElementById('opciones').value = opcionesParsed || '';
        }
    } else if (regla.tipo === 'boton') {
        document.getElementById('button_options').value = toPrettyJson(opcionesParsed || '');
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
    } else if (regla.tipo === 'flow') {
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
        if (regla.flow) {
            document.getElementById('flow_cta').value = regla.flow.cta || '';
            document.getElementById('flow_id').value = regla.flow.flow_id || '';
            document.getElementById('flow_name').value = regla.flow.flow_name || '';
            document.getElementById('flow_version').value = regla.flow.version || '';
            document.getElementById('flow_mode').value = regla.flow.mode || '';
            document.getElementById('flow_token').value = regla.flow.token || '';
            document.getElementById('flow_action').value = regla.flow.action || '';
            document.getElementById('flow_initial_screen').value = regla.flow.initial_screen || '';
            document.getElementById('flow_data').value = toPrettyJson(regla.flow.data_display || regla.flow.data || '');
            document.getElementById('flow_header').value = regla.flow.header || '';
            document.getElementById('flow_body').value = regla.flow.body || '';
            document.getElementById('flow_footer').value = regla.flow.footer || '';
        }
    } else {
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
    }
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
}
</script>
{% endblock %}
