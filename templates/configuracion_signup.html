{% extends 'base.html' %}
{% block title %}Embedded Signup{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Embedded Signup</h2>
<div class="page-tabs">
    <a class="tab-link" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
    <a class="tab-link active" href="{{ url_for('configuracion.configuracion_signup') }}">Embedded Signup</a>
</div>

<p>
    Conecta tu cuenta de WhatsApp Business desde Meta sin salir del panel.
    Usa el botón de abajo para abrir el flujo de Embedded Signup usando el
    <code>SIGNUP_FACEBOOK</code> configurado en el entorno. Al finalizar, las
    credenciales se guardarán automáticamente en esta empresa.
</p>

<div id="fb-root"></div>
<div class="card">
    <div class="form-row">
        <p class="muted">Requiere iniciar sesión en Facebook para completar el proceso.</p>
    </div>
    <div class="form-row">
        <div class="muted" style="margin-bottom: 0.25rem">Diagnóstico rápido</div>
        <ul id="wa-signup-health" class="muted" style="margin: 0; padding-left: 1rem; line-height: 1.4;">
            <li data-check="config-code">Código de configuración presente</li>
            <li data-check="app-id">FACEBOOK_APP_ID configurado</li>
            <li data-check="tenant">Tenant resuelto para el signup</li>
            <li data-check="protocol">Página servida sobre HTTPS</li>
            <li data-check="sdk">SDK de Facebook cargado</li>
        </ul>
    </div>
    <div class="form-row">
        <button
            id="wa-signup-trigger"
            class="btn-primary"
            data-config-code="{{ signup_config_code or '' }}"
            data-tenant="{{ tenant_key or '' }}"
            {% if not signup_config_code or not tenant_key or not facebook_app_id %}disabled{% endif %}
        >
            Abrir Embedded Signup
        </button>
        {% if not tenant_key %}
        <p class="alert alert-error" style="margin-top: 0.5rem">No se pudo identificar el tenant actual.</p>
        {% endif %}
        {% if not signup_config_code %}
        <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar SIGNUP_FACEBOOK en el entorno.</p>
        {% endif %}
        {% if not facebook_app_id %}
        <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar FACEBOOK_APP_ID en el entorno.</p>
        {% endif %}
        <div id="wa-signup-status" class="help" style="margin-top: 0.5rem"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const facebookSdkReady = new Promise((resolve, reject) => {
    const initSdk = () => {
      if (!window.FB) {
        reject(new Error('Facebook SDK no disponible'));
        return;
      }
      try {
        FB.init({
          appId: '{{ facebook_app_id or '' }}',
          cookie: true,
          xfbml: true,
          version: 'v20.0'
        });
        FB.AppEvents && FB.AppEvents.logPageView();
        resolve(FB);
      } catch (err) {
        console.warn('No se pudo inicializar el SDK de Facebook', err);
        reject(err);
      }
    };

    window.fbAsyncInit = initSdk;

    if (window.FB) {
      initSdk();
      return;
    }

    if (!document.getElementById('facebook-jssdk')) {
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    }
  });
</script>
<script>
  (function() {
    const trigger = document.getElementById('wa-signup-trigger');
    if (!trigger) return;

    const facebookAppId = '{{ facebook_app_id or '' }}';
    const configCode = trigger.dataset.configCode;
    const tenantKey = trigger.dataset.tenant;
    const statusBox = document.getElementById('wa-signup-status');
    const healthList = document.getElementById('wa-signup-health');

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const markHealth = (check, ok, detail) => {
      if (!healthList) return;
      const item = healthList.querySelector(`[data-check="${check}"]`);
      if (!item) return;
      const prefix = ok ? '✅' : '⚠️';
      item.textContent = `${prefix} ${detail}`;
      item.style.color = ok ? '#2c3e50' : '#c0392b';
    };

    const runSyncHealth = () => {
      markHealth('config-code', Boolean(configCode), 'Código de configuración presente');
      markHealth('app-id', Boolean(facebookAppId), 'FACEBOOK_APP_ID configurado');
      markHealth('tenant', Boolean(tenantKey), 'Tenant resuelto para el signup');
      markHealth('protocol', window.location.protocol === 'https:', 'Página servida sobre HTTPS');
    };

    runSyncHealth();

    const sdkTimeout = setTimeout(() => {
      markHealth('sdk', false, 'SDK de Facebook no respondió (ver consola del navegador)');
    }, 6000);

    window.checkLoginState = function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      facebookSdkReady.then((FB) => {
        clearTimeout(sdkTimeout);
        markHealth('sdk', true, 'SDK de Facebook cargado');
        if (FB && FB.getLoginStatus) {
          FB.getLoginStatus(function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Puedes continuar con el signup.');
            }
          });
        }
      }).catch(() => {
        updateStatus('No se pudo cargar el SDK de Facebook.', true);
      });
    };

    function handleSignupMessage(event) {
      if (event.origin !== 'https://www.facebook.com') return;
      let data = event.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch (err) { return; }
      }

      if (!data || data.type !== 'WA_EMBEDDED_SIGNUP' || data.event !== 'FINISH') {
        return;
      }

      const payload = data.data || {};
      fetch(`{{ url_for('configuracion.save_signup') }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
        .then((resp) => resp.json())
        .then((resp) => {
          if (resp.ok) {
            updateStatus(resp.message || 'Credenciales guardadas. Recarga la página para ver los cambios.');
            setTimeout(() => window.location.reload(), 1200);
          } else {
            updateStatus(resp.error || 'No se pudieron guardar las credenciales.', true);
          }
        })
        .catch(() => updateStatus('Error al enviar los datos del signup.', true));
    }

    window.addEventListener('message', handleSignupMessage);

    trigger.addEventListener('click', function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      if (!configCode) {
        updateStatus('Falta configurar SIGNUP_FACEBOOK.', true);
        return;
      }

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.login) {
          updateStatus('El SDK de Facebook no está listo. Revisa tu conexión y APP_ID.', true);
          return;
        }

        updateStatus('Abriendo el diálogo de Embedded Signup...');
        FB.login(
          function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Completa el cuadro de diálogo para continuar.');
            } else {
              updateStatus('No se pudo abrir el diálogo de Facebook. Verifica los permisos del navegador.', true);
            }
          },
          {
            config_id: configCode,
            response_type: 'code',
            override_default_response_type: true,
          },
        );
      }).catch(() => {
        const popupUrl = `https://www.facebook.com/v20.0/dialog/oauth?app_id=${encodeURIComponent(facebookAppId)}&config_id=${encodeURIComponent(configCode)}&state=${encodeURIComponent(tenantKey || 'default')}&redirect_uri=${encodeURIComponent(window.location.href)}`;
        const features = 'width=700,height=800,menubar=no,toolbar=no';
        window.open(popupUrl, 'wa_signup', features);
        updateStatus('Se abrió el flujo de Embedded Signup en una nueva ventana (modo respaldo).');
      });
    });
  })();
</script>
{% endblock %}
