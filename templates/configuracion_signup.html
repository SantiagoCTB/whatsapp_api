{% extends 'base.html' %}
{% block title %}Integraciones{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Integraciones</h2>
<div class="page-tabs">
    <a class="tab-link" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
    <a class="tab-link active" href="{{ url_for('configuracion.configuracion_signup') }}">Integraciones</a>
</div>

<p>
    Administra tus conexiones con Meta desde un solo lugar. Puedes activar
    WhatsApp Business con el flujo de Embedded Signup y habilitar el login
    de Instagram con la URL que te entrega Meta.
</p>

<div id="fb-root"></div>
<div class="integrations-grid">
    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-whatsapp.png') }}"
                alt="Logo de WhatsApp"
            >
            <div>
                <h3>WhatsApp Business</h3>
                <p class="muted">Conecta tu cuenta desde Meta y guarda las credenciales automáticamente.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted">Requiere iniciar sesión en Facebook para completar el proceso.</p>
            <div class="muted" style="margin-bottom: 0.25rem">Diagnóstico rápido</div>
            <ul id="wa-signup-health" class="muted" style="margin: 0; padding-left: 1rem; line-height: 1.4;">
                <li data-check="config-code">Código de configuración presente</li>
                <li data-check="app-id">FACEBOOK_APP_ID configurado</li>
                <li data-check="tenant">Tenant resuelto para el signup</li>
                <li data-check="protocol">Página servida sobre HTTPS</li>
                <li data-check="sdk">SDK de Facebook cargado</li>
            </ul>
            <div class="form-row" style="margin-top: 1rem;">
                <button
                    id="wa-signup-trigger"
                    class="btn-primary"
                    data-config-code="{{ signup_config_code or '' }}"
                    data-tenant="{{ tenant_key or '' }}"
                    data-waba-id="{{ tenant_waba_id or '' }}"
                    data-phone-number-id="{{ tenant_phone_number_id or '' }}"
                    {% if not signup_config_code or not tenant_key or not facebook_app_id %}disabled{% endif %}
                >
                    Abrir Embedded Signup
                </button>
                {% if not tenant_key %}
                <p class="alert alert-error" style="margin-top: 0.5rem">No se pudo identificar el tenant actual.</p>
                {% endif %}
                {% if not signup_config_code %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar WHATSAPP_EMBEDDED_SIGNUP_CONFIG_ID (o SIGNUP_FACEBOOK) en el entorno.</p>
                {% endif %}
                {% if not facebook_app_id %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar FACEBOOK_APP_ID en el entorno.</p>
                {% endif %}
                <div id="wa-signup-status" class="help" style="margin-top: 0.5rem"></div>
                <details id="wa-signup-debug-panel" style="margin-top: 0.5rem;">
                    <summary class="muted">Ver respuesta del Embedded Signup</summary>
                    <pre id="wa-signup-debug" class="help" style="white-space: pre-wrap; margin: 0.5rem 0 0;"></pre>
                </details>
            </div>
            <div class="form-row" style="margin-top: 1rem;">
                <label class="muted" for="wa-phone-select">Número de WhatsApp</label>
                <select id="wa-phone-select" disabled>
                    <option value="">Selecciona un número disponible</option>
                </select>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="wa-phone-refresh" class="btn-secondary" type="button">Actualizar lista</button>
                    <button id="wa-phone-save" class="btn-primary" type="button">Guardar número</button>
                    <button id="wa-phone-register" class="btn-primary" type="button">Registrar número</button>
                    <button id="wa-phone-deregister" class="btn-danger" type="button">Eliminar número</button>
                </div>
                <label class="muted" for="wa-phone-pin" style="margin-top: 0.5rem;">PIN verificación en dos pasos (si aplica para register)</label>
                <input id="wa-phone-pin" type="password" inputmode="numeric" placeholder="123456" maxlength="12">
                <div id="wa-phone-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
            <div class="form-row" style="margin-top: 1rem;">
                <label class="muted">Explorar datos de WhatsApp (post-signup)</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button id="wa-accounts-refresh" class="btn-secondary" type="button">Cargar cuentas (client/owned)</button>
                    <button id="wa-account-detail" class="btn-secondary" type="button">Detalle WABA</button>
                    <button id="wa-templates-refresh" class="btn-secondary" type="button">Plantillas</button>
                    <button id="wa-apps-refresh" class="btn-secondary" type="button">Apps suscritas</button>
                    <button id="wa-app-subscribe" class="btn-primary" type="button">Suscribir app</button>
                </div>
                <div id="wa-insights-status" class="help" style="margin-top: 0.5rem"></div>
                <details id="wa-insights-panel" style="margin-top: 0.5rem;">
                    <summary class="muted">Ver datos completos de Graph API</summary>
                    <pre id="wa-insights-debug" class="help" style="white-space: pre-wrap; margin: 0.5rem 0 0;"></pre>
                </details>
            </div>
            <div class="form-row" style="margin-top: 1rem;">
                <button id="wa-disconnect" class="btn-danger" type="button">Desconectar WhatsApp</button>
                <div id="wa-disconnect-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
        </div>
    </div>

    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-instagram.png') }}"
                alt="Logo de Instagram"
            >
            <div>
                <h3>Instagram</h3>
                <p class="muted">Inicia la sesión del negocio para habilitar la integración.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted">
                Usa la URL configurada en <code>SIGNUP_INSTAGRAM</code> para abrir el flujo de login.
            </p>
            {% if signup_instagram_url %}
            <button
                id="instagram-signup-trigger"
                class="btn-primary"
                type="button"
                data-signup-url="{{ signup_instagram_url }}"
            >
                Abrir signup de Instagram
            </button>
            <button
                id="instagram-disconnect"
                class="btn-danger"
                type="button"
                style="margin-left: 0.5rem;"
            >
                Desconectar Instagram
            </button>
            <div id="instagram-signup-status" class="help" style="margin-top: 0.5rem"></div>
            <div id="instagram-disconnect-status" class="help" style="margin-top: 0.5rem"></div>
            {% else %}
            <button class="btn-primary" disabled>Configura SIGNUP_INSTAGRAM</button>
            <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar SIGNUP_INSTAGRAM en el entorno.</p>
            {% endif %}
        </div>
    </div>

    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-facebook.png') }}"
                alt="Logo de Messenger"
            >
            <div>
                <h3>Messenger (Conversaciones)</h3>
                <p class="muted">Selecciona la página de Facebook para construir los chats de los últimos 30 días.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted" style="margin-top: 0;">
                Opción A: pega un <strong>token de usuario</strong>, consulta tus páginas y guarda la selección.
                Opción B: pega un <strong>token de página</strong> para guardar la integración directamente.
            </p>
            <div class="form-row" style="margin-top: 0.75rem;">
                <button
                    id="messenger-embedded-trigger"
                    class="btn-primary"
                    data-config-code="{{ messenger_embedded_code or '' }}"
                    data-tenant="{{ tenant_key or '' }}"
                    {% if not messenger_embedded_code or not facebook_app_id %}disabled{% endif %}
                >
                    Abrir Embedded Signup de Messenger
                </button>
                {% if not messenger_embedded_code %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar MESSENGER_EMBEDDED en el entorno.</p>
                {% endif %}
                {% if not facebook_app_id %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar FACEBOOK_APP_ID en el entorno.</p>
                {% endif %}
                <div id="messenger-embedded-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
            <div class="form-row">
                <label class="muted" for="messenger-user-token">Token de usuario (solo se guarda si lo envías)</label>
                <input id="messenger-user-token" type="password" placeholder="EAA...">
            </div>
            <div class="form-row">
                <label class="muted" for="messenger-page-token">Token de página (opcional)</label>
                <input id="messenger-page-token" type="password" placeholder="EAAB...">
            </div>
            <div class="form-row">
                <label class="muted" for="messenger-page-select">Página de Meta</label>
                <select id="messenger-page-select" data-current-page="{{ messenger_page_id or '' }}" disabled>
                    <option value="">Consulta tus páginas para ver opciones</option>
                </select>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="messenger-page-refresh" class="btn-secondary" type="button">Consultar páginas</button>
                    <button id="messenger-page-save" class="btn-primary" type="button">Guardar selección</button>
                </div>
                <div id="messenger-page-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
            <p class="muted" style="margin-top: 0.75rem;">
                Página actual: <strong id="messenger-page-label">{{ messenger_page_name or messenger_page_id or 'Sin seleccionar' }}</strong>
            </p>
            <div class="form-row" style="margin-top: 1rem;">
                <button id="messenger-disconnect" class="btn-danger" type="button">Desconectar Messenger</button>
                <div id="messenger-disconnect-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
        </div>
    </div>

    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-instagram.png') }}"
                alt="Logo de Instagram"
            >
            <div>
                <h3>Instagram (Conversaciones)</h3>
                <p class="muted">Configura la cuenta profesional para traer los chats de los últimos 30 días.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted" style="margin-top: 0;">
                Paso 1: pega un <strong>token de usuario</strong>. Paso 2: guarda el token para consultar las
                conversaciones.
            </p>
            <div class="muted" style="margin-bottom: 0.25rem">Diagnóstico rápido</div>
            <ul id="ig-backfill-health" class="muted" style="margin: 0 0 0.75rem; padding-left: 1rem; line-height: 1.4;">
                <li data-check="tenant">Tenant resuelto para el backfill</li>
                <li data-check="token">Token de Instagram guardado</li>
                <li data-check="account">Cuenta de Instagram identificada</li>
                <li>Conversaciones encontradas: <strong id="ig-conversation-count">{{ instagram_conversation_count if instagram_conversation_count is not none else '—' }}</strong></li>
                <li>Chats encontrados: <strong id="ig-message-count">{{ instagram_message_count if instagram_message_count is not none else '—' }}</strong></li>
            </ul>
            <div class="form-row">
                <label class="muted" for="instagram-user-token">Token de usuario (solo se guarda si lo envías)</label>
                <input id="instagram-user-token" type="password" placeholder="EAA...">
                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button id="instagram-token-save" class="btn-primary" type="button">Guardar token</button>
                </div>
                <div id="instagram-token-status" class="help" style="margin-top: 0.5rem"></div>
                {% if instagram_oauth_status %}
                <div class="alert alert-success" style="margin-top: 0.5rem;">{{ instagram_oauth_status }}</div>
                {% endif %}
                {% if instagram_oauth_error %}
                <div class="alert alert-error" style="margin-top: 0.5rem;">
                    {{ instagram_oauth_error }}
                    {% if instagram_oauth_error_details %}
                    <details style="margin-top: 0.25rem;">
                        <summary>Detalles</summary>
                        <pre style="white-space: pre-wrap; margin: 0;">{{ instagram_oauth_error_details | tojson(indent=2) }}</pre>
                    </details>
                    {% endif %}
                </div>
                {% endif %}
                <div
                    id="instagram-token-row"
                    class="help"
                    style="margin-top: 0.25rem; display: {{ 'block' if instagram_oauth_token else 'none' }};"
                >
                    Token recibido: <span id="instagram-token-value" style="word-break: break-all;">{{ instagram_oauth_token }}</span>
                </div>
            </div>
            <p class="muted" style="margin-top: 0.75rem;">
                Cuenta actual: <strong id="instagram-account-label">{{ instagram_account_name or 'Sin configurar' }}</strong>
            </p>
            <div class="form-row" style="margin-top: 1rem;">
                <button id="instagram-backfill-disconnect" class="btn-danger" type="button">Desconectar Instagram</button>
                <div id="instagram-backfill-disconnect-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const facebookSdkReady = new Promise((resolve, reject) => {
    const initSdk = () => {
      if (!window.FB) {
        reject(new Error('Facebook SDK no disponible'));
        return;
      }
      try {
        FB.init({
          appId: '{{ facebook_app_id or '' }}',
          cookie: true,
          xfbml: true,
          version: '{{ facebook_graph_api_version or 'v24.0' }}'
        });
        FB.AppEvents && FB.AppEvents.logPageView();
        resolve(FB);
      } catch (err) {
        console.warn('No se pudo inicializar el SDK de Facebook', err);
        reject(err);
      }
    };

    window.fbAsyncInit = initSdk;

    if (window.FB) {
      initSdk();
      return;
    }

    if (!document.getElementById('facebook-jssdk')) {
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    }
  });
</script>
<script>
  (function() {
    const trigger = document.getElementById('wa-signup-trigger');
    if (!trigger) return;

    const facebookAppId = '{{ facebook_app_id or '' }}';
    const configCode = trigger.dataset.configCode;
    const signupRedirectUri = {{ signup_redirect_uri | tojson }};
    const tenantKey = trigger.dataset.tenant;
    const wabaId = trigger.dataset.wabaId;
    const currentPhoneNumberId = trigger.dataset.phoneNumberId;
    const statusBox = document.getElementById('wa-signup-status');
    const debugBox = document.getElementById('wa-signup-debug');
    const debugPanel = document.getElementById('wa-signup-debug-panel');
    const healthList = document.getElementById('wa-signup-health');
    const phoneSelect = document.getElementById('wa-phone-select');
    const phoneStatus = document.getElementById('wa-phone-status');
    const phoneRefresh = document.getElementById('wa-phone-refresh');
    const phoneSave = document.getElementById('wa-phone-save');
    const phoneRegister = document.getElementById('wa-phone-register');
    const phoneDeregister = document.getElementById('wa-phone-deregister');
    const phonePin = document.getElementById('wa-phone-pin');
    const accountsRefreshButton = document.getElementById('wa-accounts-refresh');
    const accountDetailButton = document.getElementById('wa-account-detail');
    const templatesRefreshButton = document.getElementById('wa-templates-refresh');
    const appsRefreshButton = document.getElementById('wa-apps-refresh');
    const appSubscribeButton = document.getElementById('wa-app-subscribe');
    const insightsStatus = document.getElementById('wa-insights-status');
    const insightsDebug = document.getElementById('wa-insights-debug');
    const insightsPanel = document.getElementById('wa-insights-panel');
    const disconnectButton = document.getElementById('wa-disconnect');
    const disconnectStatus = document.getElementById('wa-disconnect-status');

    let waFinishReceived = false;
    let waFallbackTimer = null;

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const updatePhoneStatus = (message, isError) => {
      if (!phoneStatus) return;
      phoneStatus.textContent = message || '';
      phoneStatus.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const updateDisconnectStatus = (message, isError) => {
      if (!disconnectStatus) return;
      disconnectStatus.textContent = message || '';
      disconnectStatus.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const updateInsightsStatus = (message, isError) => {
      if (!insightsStatus) return;
      insightsStatus.textContent = message || '';
      insightsStatus.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const normalizeMetaStatus = (value, fieldName) => {
      if (typeof value !== 'string') return value;
      if (value === 'NOT_STARTED' && (!fieldName || fieldName.toLowerCase() === 'status')) {
        return 'En aprobación';
      }
      return value;
    };

    const localizeMetaStatuses = (value, fieldName) => {
      if (Array.isArray(value)) {
        return value.map((item) => localizeMetaStatuses(item));
      }
      if (!value || typeof value !== 'object') {
        return normalizeMetaStatus(value, fieldName);
      }

      const localized = {};
      Object.entries(value).forEach(([key, nestedValue]) => {
        localized[key] = localizeMetaStatuses(nestedValue, key);
      });
      return localized;
    };

    const updateInsightsDebug = (label, details) => {
      if (!insightsDebug) return;
      const lines = [label || 'Respuesta de Graph API'];
      if (typeof details !== 'undefined') {
        try {
          lines.push(JSON.stringify(localizeMetaStatuses(details), null, 2));
        } catch (err) {
          lines.push(String(details));
        }
      }
      insightsDebug.textContent = lines.join('\n');
      if (insightsPanel) insightsPanel.open = true;
    };

    const updateDebug = (label, details) => {
      if (!debugBox) return;
      const lines = [label || 'Evento recibido'];
      if (typeof details !== 'undefined') {
        if (typeof details === 'string') {
          lines.push(details);
        } else {
          try {
            lines.push(JSON.stringify(details, null, 2));
          } catch (err) {
            lines.push(String(details));
          }
        }
      }
      debugBox.textContent = lines.join('\n');
      if (debugPanel) {
        debugPanel.open = true;
      }
    };

    const resetWhatsAppUi = () => {
      if (phoneSelect) {
        phoneSelect.innerHTML = '<option value="">Selecciona un número disponible</option>';
        phoneSelect.disabled = true;
      }
      updateStatus('');
      updatePhoneStatus('Completa el signup para cargar los números disponibles.');
    };

    const markHealth = (check, ok, detail) => {
      if (!healthList) return;
      const item = healthList.querySelector(`[data-check="${check}"]`);
      if (!item) return;
      const prefix = ok ? '✅' : '⚠️';
      item.textContent = `${prefix} ${detail}`;
      item.style.color = ok ? '#2c3e50' : '#c0392b';
    };

    const runSyncHealth = () => {
      markHealth('config-code', Boolean(configCode), 'Código de configuración presente');
      markHealth('app-id', Boolean(facebookAppId), 'FACEBOOK_APP_ID configurado');
      markHealth('tenant', Boolean(tenantKey), 'Tenant resuelto para el signup');
      markHealth('protocol', window.location.protocol === 'https:', 'Página servida sobre HTTPS');
    };

    runSyncHealth();

    const sdkTimeout = setTimeout(() => {
      markHealth('sdk', false, 'SDK de Facebook no respondió (ver consola del navegador)');
    }, 6000);

    window.checkLoginState = function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      facebookSdkReady.then((FB) => {
        clearTimeout(sdkTimeout);
        markHealth('sdk', true, 'SDK de Facebook cargado');
        if (FB && FB.getLoginStatus) {
          FB.getLoginStatus(function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Puedes continuar con el signup.');
            }
          });
        }
      }).catch(() => {
        updateStatus('No se pudo cargar el SDK de Facebook.', true);
      });
    };

    const populatePhoneNumbers = (numbers) => {
      if (!phoneSelect) return;
      phoneSelect.innerHTML = '<option value="">Selecciona un número disponible</option>';
      numbers.forEach((item) => {
        if (!item || !item.id) return;
        const option = document.createElement('option');
        const labelParts = [];
        if (item.display_phone_number) labelParts.push(item.display_phone_number);
        if (item.verified_name) labelParts.push(`(${item.verified_name})`);
        option.textContent = labelParts.join(' ') || item.id;
        option.value = item.id;
        if (currentPhoneNumberId && item.id === currentPhoneNumberId) {
          option.selected = true;
        }
        phoneSelect.appendChild(option);
      });
      phoneSelect.disabled = false;
    };

    const fetchPhoneNumbers = () => {
      if (!phoneSelect) return Promise.resolve();
      updatePhoneStatus('Consultando números disponibles...');
      return fetch(`{{ url_for('configuracion.whatsapp_phone_numbers') }}`)
        .then((resp) => resp.json())
        .then((resp) => {
          if (!resp.ok) {
            updatePhoneStatus(resp.error || 'No se pudieron cargar los números.', true);
            phoneSelect.disabled = true;
            return;
          }
          populatePhoneNumbers(resp.data || []);
          updatePhoneStatus('Números cargados.');
        })
        .catch(() => {
          updatePhoneStatus('Error al consultar los números.', true);
          phoneSelect.disabled = true;
        });
    };

    const getFriendlyWabaStatus = (statusValue) => {
      if (typeof statusValue !== 'string') return '';
      if (statusValue === 'NOT_STARTED') return 'En aprobación';
      return statusValue;
    };

    const fetchWabaApprovalStatus = () => {
      if (!wabaId) return Promise.resolve();
      return fetch(`{{ url_for('configuracion.whatsapp_account_details') }}?fields=id,name,status,owner_business_info`)
        .then((resp) => resp.json())
        .then((resp) => {
          if (!resp.ok) return;
          const account = (resp && resp.account) || {};
          const onboardingStatus = account
            && account.owner_business_info
            && account.owner_business_info.marketing_messages_onboarding_status
            ? account.owner_business_info.marketing_messages_onboarding_status.status
            : '';
          const rawStatus = onboardingStatus || account.status || '';
          const friendlyStatus = getFriendlyWabaStatus(rawStatus);
          if (friendlyStatus) {
            updatePhoneStatus(`Estado del número en WABA: ${friendlyStatus}`);
          }
        })
        .catch(() => {});
    };

    let latestFinishPayload = {};

    const executePhoneNumberAction = (action, phoneNumberId, successMessage, options) => {
      const resolvedPhoneNumberId = (phoneNumberId || (phoneSelect && phoneSelect.value) || '').trim();
      if (!resolvedPhoneNumberId) {
        updatePhoneStatus('Selecciona un número para continuar.', true);
        return Promise.resolve({ ok: false });
      }

      const normalizedAction = (action || '').trim().toLowerCase();
      let pinValue = (phonePin && phonePin.value ? phonePin.value : '').trim();
      const shouldPromptPin = Boolean(options && options.promptPinIfMissing && normalizedAction === 'register');
      if (shouldPromptPin && !pinValue) {
        pinValue = (window.prompt('Meta requiere PIN para registrar este número. Ingresa el PIN de verificación en dos pasos:') || '').trim();
      }

      updatePhoneStatus(normalizedAction === 'register' ? 'Registrando número en WhatsApp...' : 'Eliminando número de WhatsApp...');
      const body = { action: normalizedAction, phone_number_id: resolvedPhoneNumberId };
      if (normalizedAction === 'register' && pinValue) {
        body.pin = pinValue;
      }

      return fetch(`{{ url_for('configuracion.whatsapp_phone_number_action') }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
        .then((resp) => resp.json())
        .then((resp) => {
          if (!resp.ok) {
            const errorMessage = String((resp.details && resp.details.error && resp.details.error.message) || '').toLowerCase();
            if (normalizedAction === 'register' && errorMessage.includes('parameter pin is required')) {
              updatePhoneStatus('Meta requiere PIN para registrar. Completa el PIN y vuelve a intentar.', true);
            } else {
              updatePhoneStatus(resp.error || 'No se pudo ejecutar la acción sobre el número.', true);
            }
            updateDebug('Error en acción manual de número', resp);
            return resp;
          }
          updatePhoneStatus(successMessage || resp.message || 'Acción ejecutada correctamente.');
          updateDebug('Respuesta de acción sobre número', resp);
          return resp;
        })
        .catch(() => {
          updatePhoneStatus('Error al ejecutar la acción sobre el número.', true);
          return { ok: false };
        });
    };

    const sendSignupPayload = (rawPayload) => {
      const payload = Object.assign({}, rawPayload || {});
      fetch(`{{ url_for('configuracion.save_signup') }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.assign({ redirect_uri: signupRedirectUri }, payload)),
      })
        .then((resp) => resp.json())
        .then((resp) => {
          if (resp.ok) {
            const savedPhoneNumberId = (resp.env && resp.env.PHONE_NUMBER_ID) || payload.phone_number_id || payload.phone_id || '';
            const currentPin = (phonePin && phonePin.value ? phonePin.value : '').trim();
            if (currentPin) {
              updateStatus(resp.message || 'Credenciales guardadas. Ejecutando registro del número...');
              executePhoneNumberAction('register', savedPhoneNumberId, 'Número registrado correctamente.').finally(() => {
                setTimeout(() => window.location.reload(), 1200);
              });
            } else {
              updateStatus((resp.message || 'Credenciales guardadas.') + ' Para completar el registro, ingresa el PIN y pulsa "Registrar número".');
              setTimeout(() => window.location.reload(), 1800);
            }
          } else {
            updateStatus(resp.error || 'No se pudieron guardar las credenciales.', true);
          }
        })
        .catch(() => updateStatus('Error al enviar los datos del signup.', true));
    };


    const fetchWhatsappInsights = (url, options, successLabel) => {
      updateInsightsStatus('Consultando Graph API...');
      fetch(url, options || {})
        .then((resp) => resp.json())
        .then((resp) => {
          if (!resp.ok) {
            updateInsightsStatus(resp.error || 'No se pudo completar la consulta.', true);
            updateInsightsDebug('Error Graph API', resp);
            return;
          }
          updateInsightsStatus(successLabel || 'Consulta completada.');
          updateInsightsDebug(successLabel || 'Consulta completada', resp);
          if (Array.isArray(resp.templates)) {
            updateStatus(`Plantillas recuperadas: ${resp.templates.length}`);
          }
        })
        .catch(() => {
          updateInsightsStatus('Error de red al consultar Graph API.', true);
        });
    };

    const handleFbLoginCallback = (response) => {
      const responseCode = response && response.authResponse ? response.authResponse.code : '';
      if (responseCode) {
        const mergedPayload = Object.assign({}, latestFinishPayload || {}, { code: responseCode });
        updateStatus('Código recibido. Intercambiando credenciales en el servidor...');
        updateDebug('FB.login devolvió code (flujo oficial)', mergedPayload);
        sendSignupPayload(mergedPayload);
        return;
      }

      if (response && response.status === 'connected') {
        updateStatus('Sesión de Facebook detectada. Completa el flujo de Embedded Signup.');
        updateDebug('FB.login status connected sin code', response);
        return;
      }

      updateStatus('No se pudo completar el flujo de Embedded Signup en Facebook.', true);
      updateDebug('FB.login no devolvió code', response || {});
    };

    function handleSignupMessage(event) {
      if (event.origin !== 'https://www.facebook.com' && event.origin !== 'https://web.facebook.com') return;
      let data = event.data;
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch (err) {
          updateDebug('Mensaje no JSON recibido desde Embedded Signup', event.data);
          return;
        }
      }

      if (!data || data.type !== 'WA_EMBEDDED_SIGNUP') {
        return;
      }

      const eventType = (data.event || '').toUpperCase();
      updateDebug(`Evento ${eventType || 'DESCONOCIDO'} recibido por postMessage`, data);

      if (eventType === 'FINISH' || eventType === 'FINISH_ONLY_WABA' || eventType === 'FINISH_WHATSAPP_BUSINESS_APP_ONBOARDING') {
        waFinishReceived = true;
        latestFinishPayload = Object.assign({}, data.data || {});
        updateStatus('Embedded Signup completado. Esperando callback de Facebook para recibir el code...');
        return;
      }

      if (eventType === 'CANCEL') {
        const errorInfo = data && data.data && data.data.error_message
          ? ` (${data.data.error_message})`
          : '';
        updateStatus(`El flujo de Embedded Signup se canceló${errorInfo}.`, true);
      }
    }

    window.addEventListener('message', handleSignupMessage);

    trigger.addEventListener('click', function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      if (!configCode) {
        updateStatus('Falta configurar WHATSAPP_EMBEDDED_SIGNUP_CONFIG_ID (o SIGNUP_FACEBOOK).', true);
        return;
      }

      waFinishReceived = false;
      latestFinishPayload = {};

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.login) {
          updateStatus('El SDK de Facebook no está listo. Revisa tu conexión y APP_ID.', true);
          return;
        }

        updateStatus('Abriendo el diálogo de Embedded Signup (SDK oficial de Meta)...');
        FB.login(
          handleFbLoginCallback,
          {
            config_id: configCode,
            response_type: 'code',
            override_default_response_type: true,
            extras: {
              version: 'v3',
              sessionInfoVersion: '3',
              setup: {
                business: {
                  id: null,
                  name: null,
                  email: null,
                  phone: { code: null, number: null },
                  website: null,
                  address: {
                    streetAddress1: null,
                    streetAddress2: null,
                    city: null,
                    state: null,
                    zipPostal: null,
                    country: null,
                  },
                  timezone: null,
                },
                phone: {
                  displayName: null,
                  category: null,
                  description: null,
                },
                preVerifiedPhone: { ids: null },
                solutionID: null,
                whatsAppBusinessAccount: { ids: null },
              },
            },
          },
        );
      }).catch(() => {
        updateStatus('No se pudo cargar el SDK de Facebook. Recarga la página y revisa bloqueadores de scripts/cookies.', true);
      });
    });

    if (wabaId) {
      fetchPhoneNumbers().finally(() => fetchWabaApprovalStatus());
    } else {
      updatePhoneStatus('Completa el signup para cargar los números disponibles.');
    }

    if (phoneRefresh) {
      phoneRefresh.addEventListener('click', () => {
        fetchPhoneNumbers().finally(() => fetchWabaApprovalStatus());
      });
    }

    if (phoneSave) {
      phoneSave.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para guardar.', true);
          return;
        }
        updatePhoneStatus('Guardando número seleccionado...');
        fetch(`{{ url_for('configuracion.whatsapp_save_phone_number') }}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone_number_id: phoneSelect.value }),
        })
          .then((resp) => resp.json())
          .then((resp) => {
            if (resp.ok) {
              updatePhoneStatus(resp.message || 'Número actualizado.');
            } else {
              updatePhoneStatus(resp.error || 'No se pudo guardar el número.', true);
            }
          })
          .catch(() => updatePhoneStatus('Error al guardar el número.', true));
      });
    }

    if (phoneDeregister) {
      phoneDeregister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para eliminar.', true);
          return;
        }
        executePhoneNumberAction('deregister', phoneSelect.value, 'Número eliminado correctamente.');
      });
    }

    if (phoneRegister) {
      phoneRegister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para registrar.', true);
          return;
        }
        executePhoneNumberAction('register', phoneSelect.value, 'Número registrado correctamente.');
      });
    }

    if (phoneDeregister) {
      phoneDeregister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para eliminar.', true);
          return;
        }
        executePhoneNumberAction('deregister', phoneSelect.value, 'Número eliminado correctamente.');
      });
    }

    if (phoneRegister) {
      phoneRegister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para registrar.', true);
          return;
        }
        executePhoneNumberAction('register', phoneSelect.value, 'Número registrado correctamente.');
      });
    }

    if (phoneDeregister) {
      phoneDeregister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para eliminar.', true);
          return;
        }
        executePhoneNumberAction('deregister', phoneSelect.value, 'Número eliminado correctamente.');
      });
    }

    if (phoneRegister) {
      phoneRegister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para registrar.', true);
          return;
        }
        executePhoneNumberAction('register', phoneSelect.value, 'Número registrado correctamente.', { promptPinIfMissing: true });
      });
    }

    if (phoneDeregister) {
      phoneDeregister.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para eliminar.', true);
          return;
        }
        executePhoneNumberAction('deregister', phoneSelect.value, 'Número eliminado correctamente.');
      });
    }

    if (accountsRefreshButton) {
      accountsRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_accounts') }}`, { method: 'GET' }, 'Cuentas de WhatsApp cargadas.');
      });
    }

    if (accountDetailButton) {
      accountDetailButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_account_details') }}`, { method: 'GET' }, 'Detalle de cuenta WABA cargado.');
      });
    }

    if (templatesRefreshButton) {
      templatesRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_message_templates') }}`, { method: 'GET' }, 'Plantillas de mensajes cargadas.');
      });
    }

    if (appsRefreshButton) {
      appsRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_subscribed_apps') }}`, { method: 'GET' }, 'Apps suscritas cargadas.');
      });
    }

    if (appSubscribeButton) {
      appSubscribeButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_subscribe_app') }}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        }, 'App suscrita correctamente.');
      });
    }

    if (disconnectButton) {
      disconnectButton.addEventListener('click', async () => {
        if (!confirm('¿Seguro que deseas desconectar WhatsApp y borrar las credenciales guardadas?')) {
          return;
        }
        disconnectButton.disabled = true;
        updateDisconnectStatus('Desconectando WhatsApp...', false);
        try {
          const response = await fetch('{{ url_for("configuracion.whatsapp_reset_signup") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'No se pudieron limpiar los datos anteriores.');
          }
          resetWhatsAppUi();
          updateDisconnectStatus('WhatsApp desconectado correctamente.', false);
        } catch (err) {
          updateDisconnectStatus(err.message || 'No se pudieron limpiar los datos anteriores.', true);
        } finally {
          disconnectButton.disabled = false;
        }
      });
    }
  })();
</script>
<script>
  (function() {
    const messengerTrigger = document.getElementById('messenger-embedded-trigger');
    if (!messengerTrigger) return;

    const facebookAppId = '{{ facebook_app_id or '' }}';
    const messengerEmbeddedCode = messengerTrigger.dataset.configCode;
    const signupRedirectUri = {{ signup_redirect_uri | tojson }};
    const tenantKey = messengerTrigger.dataset.tenant;
    const statusBox = document.getElementById('messenger-embedded-status');
    let messengerCodeHandled = false;

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const sendMessengerPayload = (payload) => {
      updateStatus('Enviando datos del Embedded Signup a tu servidor...');
      fetch(`{{ url_for('configuracion.messenger_signup') }}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(Object.assign({ redirect_uri: signupRedirectUri }, payload || {})),
      })
        .then((resp) => resp.json())
        .then((resp) => {
          if (resp.ok) {
            updateStatus(resp.message || 'Token de Messenger actualizado.');
          } else {
            const details = resp.details && resp.details.error
              ? ` Detalle: ${resp.details.error.message || resp.details.error.error_user_msg || ''}`
              : '';
            updateStatus((resp.error || 'No se pudo guardar el token de Messenger.') + details, true);
          }
        })
        .catch(() => updateStatus('Error al enviar los datos del signup.', true));
    };

    const parseMessengerCodeFromMessage = (rawData) => {
      if (!rawData || typeof rawData !== 'string') return '';

      const normalized = rawData.trim().replace(/^#/, '').replace(/^\?/, '');
      if (!normalized) return '';

      const params = new URLSearchParams(normalized);
      return (params.get('code') || '').trim();
    };

    const handleMessengerCode = (code, source) => {
      const normalizedCode = (code || '').trim();
      if (!normalizedCode || messengerCodeHandled) return;

      messengerCodeHandled = true;
      updateStatus('Código de Messenger recibido. Intercambiando token en el servidor...');
      sendMessengerPayload({ code: normalizedCode, source });
    };

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://www.facebook.com' && event.origin !== 'https://web.facebook.com') return;

      const rawData = typeof event.data === 'string' ? event.data : '';
      const parsedCode = parseMessengerCodeFromMessage(rawData);
      if (parsedCode) {
        handleMessengerCode(parsedCode, 'post_message_querystring');
      }
    });

    messengerTrigger.addEventListener('click', function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      if (!messengerEmbeddedCode) {
        updateStatus('Falta configurar MESSENGER_EMBEDDED.', true);
        return;
      }

      messengerCodeHandled = false;

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.login) {
          updateStatus('El SDK de Facebook no está listo. Revisa tu conexión y APP_ID.', true);
          return;
        }

        updateStatus('Abriendo el flujo Embedded Signup de Messenger...');
        FB.login(
          function(response) {
            console.log('Respuesta Embedded Signup Messenger', response);
            const responseCode = response && response.authResponse ? response.authResponse.code : '';
            const responseToken = response && response.authResponse ? response.authResponse.accessToken : '';
            if (responseCode) {
              handleMessengerCode(responseCode, 'fb_login_auth_response');
              return;
            }
            if (responseToken) {
              updateStatus('Sesión iniciada en Facebook. Completa el asistente de Embedded Signup para continuar.');
              return;
            }
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Completa el cuadro de diálogo para continuar.');
              return;
            }
            const errorMessage = response && response.error_message
              ? `No se completó el flujo: ${response.error_message}`
              : 'No se completó el flujo de Facebook. Verifica permisos y redirección.';
            updateStatus(errorMessage, true);
          },
          {
            config_id: messengerEmbeddedCode,
            response_type: 'code',
            override_default_response_type: true,
          },
        );
      }).catch(() => {
        const popupUrl = `https://www.facebook.com/{{ facebook_graph_api_version or 'v24.0' }}/dialog/oauth?app_id=${encodeURIComponent(facebookAppId)}&config_id=${encodeURIComponent(messengerEmbeddedCode)}&state=${encodeURIComponent(tenantKey || 'default')}&redirect_uri=${encodeURIComponent(signupRedirectUri)}`;
        const features = 'width=700,height=800,menubar=no,toolbar=no';
        window.open(popupUrl, 'messenger_signup', features);
        updateStatus('Se abrió el flujo de Embedded Signup de Messenger en una nueva ventana (modo respaldo).');
      });
    });
  })();
</script>
<script>
  (function() {
    const setupPageIntegration = ({
      platform,
      refreshButtonId,
      saveButtonId,
      pageSelectId,
      tokenInputId,
      pageTokenInputId,
      statusBoxId
    }) => {
      const refreshButton = document.getElementById(refreshButtonId);
      const saveButton = document.getElementById(saveButtonId);
      const pageSelect = document.getElementById(pageSelectId);
      const tokenInput = document.getElementById(tokenInputId);
      const pageTokenInput = pageTokenInputId ? document.getElementById(pageTokenInputId) : null;
      const statusBox = document.getElementById(statusBoxId);

      if (!refreshButton || !saveButton || !pageSelect) return;

      const setStatus = (message, isError) => {
        if (!statusBox) return;
        statusBox.textContent = message || '';
        statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
      };

      const getToken = () => (tokenInput && tokenInput.value ? tokenInput.value.trim() : '');
      const getPageToken = () => (pageTokenInput && pageTokenInput.value ? pageTokenInput.value.trim() : '');

      refreshButton.addEventListener('click', async () => {
        setStatus('Consultando páginas...', false);
        const payload = { platform };
        const token = getToken();
        if (token) {
          payload.user_access_token = token;
        }
        const pageToken = getPageToken();
        if (pageToken) {
          payload.page_access_token = pageToken;
        }

        try {
          const response = await fetch('{{ url_for("configuracion.messenger_pages") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'No se pudieron obtener las páginas.');
          }

          pageSelect.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Selecciona una página';
          pageSelect.appendChild(placeholder);

          const currentPageId = pageSelect.dataset.currentPage || '';
          (data.pages || []).forEach((page) => {
            const option = document.createElement('option');
            option.value = page.id;
            option.textContent = page.name || page.id;
            if (currentPageId && page.id === currentPageId) {
              option.selected = true;
            }
            pageSelect.appendChild(option);
          });

          pageSelect.disabled = false;
          setStatus('Páginas cargadas. Selecciona una para guardar.', false);
        } catch (err) {
          pageSelect.disabled = true;
          setStatus(err.message || 'No se pudieron obtener las páginas.', true);
        }
      });

      saveButton.addEventListener('click', async () => {
        const selectedPage = pageSelect.value;
        const pageToken = getPageToken();
        if (!selectedPage && !pageToken) {
          setStatus('Selecciona una página o pega un token de página.', true);
          return;
        }
        const payload = {
          platform
        };
        if (selectedPage) {
          payload.page_id = selectedPage;
        }
        const token = getToken();
        if (token) {
          payload.user_access_token = token;
        }
        if (pageToken) {
          payload.page_access_token = pageToken;
        }

        setStatus('Guardando selección...', false);
        try {
          const response = await fetch('{{ url_for("configuracion.messenger_save_page") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'No se pudo guardar la página.');
          }
          setStatus('Página guardada correctamente. El backfill se ejecutará en segundo plano.', false);
        } catch (err) {
          setStatus(err.message || 'No se pudo guardar la página.', true);
        }
      });
    };

    setupPageIntegration({
      platform: 'messenger',
      refreshButtonId: 'messenger-page-refresh',
      saveButtonId: 'messenger-page-save',
      pageSelectId: 'messenger-page-select',
      tokenInputId: 'messenger-user-token',
      pageTokenInputId: 'messenger-page-token',
      statusBoxId: 'messenger-page-status'
    });

    const setupMessengerDisconnect = () => {
      const disconnectButton = document.getElementById('messenger-disconnect');
      if (!disconnectButton) return;

      const statusBox = document.getElementById('messenger-disconnect-status');
      const userTokenInput = document.getElementById('messenger-user-token');
      const pageTokenInput = document.getElementById('messenger-page-token');
      const pageSelect = document.getElementById('messenger-page-select');
      const pageStatus = document.getElementById('messenger-page-status');
      const embeddedStatus = document.getElementById('messenger-embedded-status');
      const pageLabel = document.getElementById('messenger-page-label');

      const updateStatus = (message, isError) => {
        if (!statusBox) return;
        statusBox.textContent = message || '';
        statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
      };

      const resetMessengerUi = () => {
        if (userTokenInput) userTokenInput.value = '';
        if (pageTokenInput) pageTokenInput.value = '';
        if (pageSelect) {
          pageSelect.innerHTML = '<option value="">Consulta tus páginas para ver opciones</option>';
          pageSelect.disabled = true;
          pageSelect.dataset.currentPage = '';
        }
        if (pageLabel) pageLabel.textContent = 'Sin seleccionar';
        if (pageStatus) pageStatus.textContent = '';
        if (embeddedStatus) embeddedStatus.textContent = '';
      };

      disconnectButton.addEventListener('click', async () => {
        if (!confirm('¿Seguro que deseas desconectar Messenger y borrar los datos guardados?')) {
          return;
        }
        disconnectButton.disabled = true;
        updateStatus('Desconectando Messenger...', false);
        try {
          const response = await fetch('{{ url_for("configuracion.messenger_reset_signup") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({}),
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'No se pudieron limpiar los datos anteriores.');
          }
          resetMessengerUi();
          updateStatus('Messenger desconectado correctamente.', false);
        } catch (err) {
          updateStatus(err.message || 'No se pudieron limpiar los datos anteriores.', true);
        } finally {
          disconnectButton.disabled = false;
        }
      });
    };

    setupMessengerDisconnect();
    const setupInstagramToken = () => {
      const tokenInput = document.getElementById('instagram-user-token');
      const saveButton = document.getElementById('instagram-token-save');
      const statusBox = document.getElementById('instagram-token-status');
      const tokenRow = document.getElementById('instagram-token-row');
      const tokenValue = document.getElementById('instagram-token-value');
      const accountLabel = document.getElementById('instagram-account-label');
      const healthList = document.getElementById('ig-backfill-health');

      if (!tokenInput || !saveButton || !statusBox) {
        return;
      }

      const setStatus = (message, isError = false) => {
        statusBox.textContent = message;
        statusBox.style.color = isError ? '#dc3545' : '#198754';
      };

      const updateTokenDisplay = (token) => {
        if (!tokenRow || !tokenValue) return;
        if (!token) {
          tokenValue.textContent = '';
          tokenRow.style.display = 'none';
          return;
        }
        tokenValue.textContent = token;
        tokenRow.style.display = 'block';
      };

      const markHealth = (check, ok, detail) => {
        if (!healthList) return;
        const item = healthList.querySelector(`[data-check="${check}"]`);
        if (!item) return;
        const prefix = ok ? '✅' : '⚠️';
        item.textContent = `${prefix} ${detail}`;
        item.style.color = ok ? '#2c3e50' : '#c0392b';
      };

      const updateHealth = ({ hasToken, hasAccount } = {}) => {
        const resolvedToken = typeof hasToken === 'boolean'
          ? hasToken
          : {{ 'true' if instagram_token_present else 'false' }};
        const resolvedAccount = typeof hasAccount === 'boolean'
          ? hasAccount
          : Boolean('{{ instagram_account_name or '' }}');
        markHealth('tenant', Boolean('{{ tenant_key or '' }}'), 'Tenant resuelto para el backfill');
        markHealth('token', resolvedToken, 'Token de Instagram guardado');
        markHealth('account', resolvedAccount, 'Cuenta de Instagram identificada');
      };

      updateHealth();

      saveButton.addEventListener('click', async () => {
        const token = tokenInput.value.trim();
        if (!token) {
          setStatus('Ingresa un token de Instagram antes de guardar.', true);
          return;
        }

        updateTokenDisplay(token);
        setStatus('Validando token...', false);
        try {
          const response = await fetch('{{ url_for("configuracion.instagram_save_token") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_access_token: token })
          });
          const data = await response.json();
          if (!response.ok || !data.ok) {
            throw new Error(data.error || 'No se pudo guardar el token.');
          }

          const account = data.account || {};
          const label = account.username || account.id || 'Sin configurar';
          if (accountLabel) {
            accountLabel.textContent = label;
          }
          updateHealth({ hasToken: true, hasAccount: Boolean(label && label !== 'Sin configurar') });
          setStatus('Token guardado correctamente. El backfill se ejecutará en segundo plano.', false);
        } catch (err) {
          setStatus(err.message || 'No se pudo guardar el token.', true);
        }
      });
    };

    setupInstagramToken();
  })();
</script>
<script>
  (function() {
    const trigger = document.getElementById('instagram-signup-trigger');
    if (!trigger) return;

    const statusBox = document.getElementById('instagram-signup-status');
    const disconnectButton = document.getElementById('instagram-disconnect');
    const disconnectStatus = document.getElementById('instagram-disconnect-status');
    const backfillDisconnectButton = document.getElementById('instagram-backfill-disconnect');
    const backfillDisconnectStatus = document.getElementById('instagram-backfill-disconnect-status');
    const signupUrl = trigger.dataset.signupUrl;

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const updateDisconnectStatus = (target, message, isError) => {
      if (!target) return;
      target.textContent = message || '';
      target.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const resetInstagramUi = () => {
      const tokenInput = document.getElementById('instagram-user-token');
      const tokenStatus = document.getElementById('instagram-token-status');
      const tokenRow = document.getElementById('instagram-token-row');
      const tokenValue = document.getElementById('instagram-token-value');
      const accountLabel = document.getElementById('instagram-account-label');
      const conversationCount = document.getElementById('ig-conversation-count');
      const messageCount = document.getElementById('ig-message-count');
      const healthList = document.getElementById('ig-backfill-health');

      if (tokenInput) tokenInput.value = '';
      if (tokenStatus) {
        tokenStatus.textContent = '';
        tokenStatus.style.color = '#198754';
      }
      if (tokenRow) tokenRow.style.display = 'none';
      if (tokenValue) tokenValue.textContent = '';
      if (accountLabel) accountLabel.textContent = 'Sin configurar';
      if (conversationCount) conversationCount.textContent = '—';
      if (messageCount) messageCount.textContent = '—';
      if (healthList) {
        const items = {
          tenant: 'Tenant resuelto para el backfill',
          token: 'Token de Instagram guardado',
          account: 'Cuenta de Instagram identificada',
        };
        Object.entries(items).forEach(([key, label]) => {
          const item = healthList.querySelector(`[data-check="${key}"]`);
          if (item) {
            item.textContent = `⚠️ ${label}`;
            item.style.color = '#c0392b';
          }
        });
      }
    };

    const resetInstagram = async ({ button, statusTarget, successMessage }) => {
      if (!confirm('¿Seguro que deseas desconectar Instagram y borrar los datos guardados?')) {
        return;
      }
      if (button) button.disabled = true;
      updateDisconnectStatus(statusTarget, 'Desconectando Instagram...', false);
      try {
        const response = await fetch('{{ url_for("configuracion.instagram_reset_signup") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.error || 'No se pudieron limpiar los datos anteriores.');
        }
        resetInstagramUi();
        updateDisconnectStatus(statusTarget, successMessage, false);
      } catch (err) {
        updateDisconnectStatus(statusTarget, err.message || 'No se pudieron limpiar los datos anteriores.', true);
      } finally {
        if (button) button.disabled = false;
      }
    };

    trigger.addEventListener('click', async () => {
      if (!signupUrl) {
        updateStatus('Falta configurar SIGNUP_INSTAGRAM.', true);
        return;
      }

      trigger.disabled = true;
      updateStatus('Limpiando datos anteriores de Instagram...', false);
      try {
        const response = await fetch('{{ url_for("configuracion.instagram_reset_signup") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          throw new Error(data.error || 'No se pudieron limpiar los datos anteriores.');
        }
        resetInstagramUi();
        updateStatus('Datos limpiados. Abriendo el signup de Instagram...', false);
        window.open(signupUrl, '_blank', 'noopener');
      } catch (err) {
        updateStatus(err.message || 'No se pudieron limpiar los datos anteriores.', true);
      } finally {
        trigger.disabled = false;
      }
    });


    if (accountsRefreshButton) {
      accountsRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_accounts') }}`, { method: 'GET' }, 'Cuentas de WhatsApp cargadas.');
      });
    }

    if (accountDetailButton) {
      accountDetailButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_account_details') }}`, { method: 'GET' }, 'Detalle de cuenta WABA cargado.');
      });
    }

    if (templatesRefreshButton) {
      templatesRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_message_templates') }}`, { method: 'GET' }, 'Plantillas de mensajes cargadas.');
      });
    }

    if (appsRefreshButton) {
      appsRefreshButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_subscribed_apps') }}`, { method: 'GET' }, 'Apps suscritas cargadas.');
      });
    }

    if (appSubscribeButton) {
      appSubscribeButton.addEventListener('click', () => {
        fetchWhatsappInsights(`{{ url_for('configuracion.whatsapp_subscribe_app') }}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        }, 'App suscrita correctamente.');
      });
    }

    if (disconnectButton) {
      disconnectButton.addEventListener('click', () => {
        resetInstagram({
          button: disconnectButton,
          statusTarget: disconnectStatus,
          successMessage: 'Instagram desconectado correctamente.',
        });
      });
    }

    if (backfillDisconnectButton) {
      backfillDisconnectButton.addEventListener('click', () => {
        resetInstagram({
          button: backfillDisconnectButton,
          statusTarget: backfillDisconnectStatus,
          successMessage: 'Instagram desconectado correctamente.',
        });
      });
    }
  })();
</script>
{% endblock %}
