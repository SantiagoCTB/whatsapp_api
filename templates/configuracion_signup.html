{% extends 'base.html' %}
{% block title %}Integraciones{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Integraciones</h2>
<div class="page-tabs">
    <a class="tab-link" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
    <a class="tab-link active" href="{{ url_for('configuracion.configuracion_signup') }}">Integraciones</a>
</div>

<p>
    Administra tus conexiones con Meta desde un solo lugar. Puedes activar
    WhatsApp Business con el flujo de Embedded Signup y habilitar el login
    de Instagram con la URL que te entrega Meta.
</p>

<div id="fb-root"></div>
<div class="integrations-grid">
    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-whatsapp.png') }}"
                alt="Logo de WhatsApp"
            >
            <div>
                <h3>WhatsApp Business</h3>
                <p class="muted">Conecta tu cuenta desde Meta y guarda las credenciales automáticamente.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted">Requiere iniciar sesión en Facebook para completar el proceso.</p>
            <div class="muted" style="margin-bottom: 0.25rem">Diagnóstico rápido</div>
            <ul id="wa-signup-health" class="muted" style="margin: 0; padding-left: 1rem; line-height: 1.4;">
                <li data-check="config-code">Código de configuración presente</li>
                <li data-check="app-id">FACEBOOK_APP_ID configurado</li>
                <li data-check="tenant">Tenant resuelto para el signup</li>
                <li data-check="protocol">Página servida sobre HTTPS</li>
                <li data-check="sdk">SDK de Facebook cargado</li>
            </ul>
            <div class="form-row" style="margin-top: 1rem;">
                <button
                    id="wa-signup-trigger"
                    class="btn-primary"
                    data-config-code="{{ signup_config_code or '' }}"
                    data-tenant="{{ tenant_key or '' }}"
                    data-waba-id="{{ tenant_waba_id or '' }}"
                    data-phone-number-id="{{ tenant_phone_number_id or '' }}"
                    {% if not signup_config_code or not tenant_key or not facebook_app_id %}disabled{% endif %}
                >
                    Abrir Embedded Signup
                </button>
                {% if not tenant_key %}
                <p class="alert alert-error" style="margin-top: 0.5rem">No se pudo identificar el tenant actual.</p>
                {% endif %}
                {% if not signup_config_code %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar SIGNUP_FACEBOOK en el entorno.</p>
                {% endif %}
                {% if not facebook_app_id %}
                <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar FACEBOOK_APP_ID en el entorno.</p>
                {% endif %}
                <div id="wa-signup-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
            <div class="form-row" style="margin-top: 1rem;">
                <label class="muted" for="wa-phone-select">Número de WhatsApp</label>
                <select id="wa-phone-select" disabled>
                    <option value="">Selecciona un número disponible</option>
                </select>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="wa-phone-refresh" class="btn-secondary" type="button">Actualizar lista</button>
                    <button id="wa-phone-save" class="btn-primary" type="button">Guardar número</button>
                </div>
                <div id="wa-phone-status" class="help" style="margin-top: 0.5rem"></div>
            </div>
        </div>
    </div>

    <div class="integration-card card">
        <div class="integration-header">
            <img
                class="integration-logo"
                src="{{ url_for('static', filename='logo-instagram.png') }}"
                alt="Logo de Instagram"
            >
            <div>
                <h3>Instagram</h3>
                <p class="muted">Inicia la sesión del negocio para habilitar la integración.</p>
            </div>
        </div>
        <div class="integration-body">
            <p class="muted">
                Usa la URL configurada en <code>SIGNUP_INSTRAGRAM</code> para abrir el flujo de login.
            </p>
            {% if signup_instagram_url %}
            <a
                class="btn-primary"
                href="{{ signup_instagram_url }}"
                target="_blank"
                rel="noopener"
            >
                Abrir signup de Instagram
            </a>
            {% else %}
            <button class="btn-primary" disabled>Configura SIGNUP_INSTRAGRAM</button>
            <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar SIGNUP_INSTRAGRAM en el entorno.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const facebookSdkReady = new Promise((resolve, reject) => {
    const initSdk = () => {
      if (!window.FB) {
        reject(new Error('Facebook SDK no disponible'));
        return;
      }
      try {
        FB.init({
          appId: '{{ facebook_app_id or '' }}',
          cookie: true,
          xfbml: true,
          version: 'v20.0'
        });
        FB.AppEvents && FB.AppEvents.logPageView();
        resolve(FB);
      } catch (err) {
        console.warn('No se pudo inicializar el SDK de Facebook', err);
        reject(err);
      }
    };

    window.fbAsyncInit = initSdk;

    if (window.FB) {
      initSdk();
      return;
    }

    if (!document.getElementById('facebook-jssdk')) {
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    }
  });
</script>
<script>
  (function() {
    const trigger = document.getElementById('wa-signup-trigger');
    if (!trigger) return;

    const facebookAppId = '{{ facebook_app_id or '' }}';
    const configCode = trigger.dataset.configCode;
    const tenantKey = trigger.dataset.tenant;
    const wabaId = trigger.dataset.wabaId;
    const currentPhoneNumberId = trigger.dataset.phoneNumberId;
    const statusBox = document.getElementById('wa-signup-status');
    const healthList = document.getElementById('wa-signup-health');
    const phoneSelect = document.getElementById('wa-phone-select');
    const phoneStatus = document.getElementById('wa-phone-status');
    const phoneRefresh = document.getElementById('wa-phone-refresh');
    const phoneSave = document.getElementById('wa-phone-save');

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const updatePhoneStatus = (message, isError) => {
      if (!phoneStatus) return;
      phoneStatus.textContent = message || '';
      phoneStatus.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    const markHealth = (check, ok, detail) => {
      if (!healthList) return;
      const item = healthList.querySelector(`[data-check="${check}"]`);
      if (!item) return;
      const prefix = ok ? '✅' : '⚠️';
      item.textContent = `${prefix} ${detail}`;
      item.style.color = ok ? '#2c3e50' : '#c0392b';
    };

    const runSyncHealth = () => {
      markHealth('config-code', Boolean(configCode), 'Código de configuración presente');
      markHealth('app-id', Boolean(facebookAppId), 'FACEBOOK_APP_ID configurado');
      markHealth('tenant', Boolean(tenantKey), 'Tenant resuelto para el signup');
      markHealth('protocol', window.location.protocol === 'https:', 'Página servida sobre HTTPS');
    };

    runSyncHealth();

    const sdkTimeout = setTimeout(() => {
      markHealth('sdk', false, 'SDK de Facebook no respondió (ver consola del navegador)');
    }, 6000);

    window.checkLoginState = function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      facebookSdkReady.then((FB) => {
        clearTimeout(sdkTimeout);
        markHealth('sdk', true, 'SDK de Facebook cargado');
        if (FB && FB.getLoginStatus) {
          FB.getLoginStatus(function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Puedes continuar con el signup.');
            }
          });
        }
      }).catch(() => {
        updateStatus('No se pudo cargar el SDK de Facebook.', true);
      });
    };

    const populatePhoneNumbers = (numbers) => {
      if (!phoneSelect) return;
      phoneSelect.innerHTML = '<option value="">Selecciona un número disponible</option>';
      numbers.forEach((item) => {
        if (!item || !item.id) return;
        const option = document.createElement('option');
        const labelParts = [];
        if (item.display_phone_number) labelParts.push(item.display_phone_number);
        if (item.verified_name) labelParts.push(`(${item.verified_name})`);
        option.textContent = labelParts.join(' ') || item.id;
        option.value = item.id;
        if (currentPhoneNumberId && item.id === currentPhoneNumberId) {
          option.selected = true;
        }
        phoneSelect.appendChild(option);
      });
      phoneSelect.disabled = false;
    };

    const fetchPhoneNumbers = () => {
      if (!phoneSelect) return;
      updatePhoneStatus('Consultando números disponibles...');
      fetch(`{{ url_for('configuracion.whatsapp_phone_numbers') }}`)
        .then((resp) => resp.json())
        .then((resp) => {
          if (!resp.ok) {
            updatePhoneStatus(resp.error || 'No se pudieron cargar los números.', true);
            phoneSelect.disabled = true;
            return;
          }
          populatePhoneNumbers(resp.data || []);
          updatePhoneStatus('Números cargados.');
        })
        .catch(() => {
          updatePhoneStatus('Error al consultar los números.', true);
          phoneSelect.disabled = true;
        });
    };

    function handleSignupMessage(event) {
      if (event.origin !== 'https://www.facebook.com') return;
      let data = event.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch (err) { return; }
      }

      if (!data || data.type !== 'WA_EMBEDDED_SIGNUP' || data.event !== 'FINISH') {
        return;
      }

      const payload = data.data || {};

      const sendPayload = (token) => {
        if (token && !payload.access_token) {
          payload.access_token = token;
        }
        fetch(`{{ url_for('configuracion.save_signup') }}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
          .then((resp) => resp.json())
          .then((resp) => {
            if (resp.ok) {
              updateStatus(resp.message || 'Credenciales guardadas. Recarga la página para ver los cambios.');
              setTimeout(() => window.location.reload(), 1200);
            } else {
              updateStatus(resp.error || 'No se pudieron guardar las credenciales.', true);
            }
          })
          .catch(() => updateStatus('Error al enviar los datos del signup.', true));
      };

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.getLoginStatus) {
          sendPayload();
          return;
        }
        FB.getLoginStatus((response) => {
          const token = response && response.authResponse ? response.authResponse.accessToken : null;
          sendPayload(token);
        });
      }).catch(() => sendPayload());
    }

    window.addEventListener('message', handleSignupMessage);

    trigger.addEventListener('click', function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      if (!configCode) {
        updateStatus('Falta configurar SIGNUP_FACEBOOK.', true);
        return;
      }

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.login) {
          updateStatus('El SDK de Facebook no está listo. Revisa tu conexión y APP_ID.', true);
          return;
        }

        updateStatus('Abriendo el diálogo de Embedded Signup...');
        FB.login(
          function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Completa el cuadro de diálogo para continuar.');
            } else {
              updateStatus('No se pudo abrir el diálogo de Facebook. Verifica los permisos del navegador.', true);
            }
          },
          {
            config_id: configCode,
            response_type: 'code',
            override_default_response_type: true,
          },
        );
      }).catch(() => {
        const popupUrl = `https://www.facebook.com/v20.0/dialog/oauth?app_id=${encodeURIComponent(facebookAppId)}&config_id=${encodeURIComponent(configCode)}&state=${encodeURIComponent(tenantKey || 'default')}&redirect_uri=${encodeURIComponent(window.location.href)}`;
        const features = 'width=700,height=800,menubar=no,toolbar=no';
        window.open(popupUrl, 'wa_signup', features);
        updateStatus('Se abrió el flujo de Embedded Signup en una nueva ventana (modo respaldo).');
      });
    });

    if (wabaId) {
      fetchPhoneNumbers();
    } else {
      updatePhoneStatus('Completa el signup para cargar los números disponibles.');
    }

    if (phoneRefresh) {
      phoneRefresh.addEventListener('click', fetchPhoneNumbers);
    }

    if (phoneSave) {
      phoneSave.addEventListener('click', () => {
        if (!phoneSelect || !phoneSelect.value) {
          updatePhoneStatus('Selecciona un número para guardar.', true);
          return;
        }
        updatePhoneStatus('Guardando número seleccionado...');
        fetch(`{{ url_for('configuracion.whatsapp_save_phone_number') }}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone_number_id: phoneSelect.value }),
        })
          .then((resp) => resp.json())
          .then((resp) => {
            if (resp.ok) {
              updatePhoneStatus(resp.message || 'Número actualizado.');
            } else {
              updatePhoneStatus(resp.error || 'No se pudo guardar el número.', true);
            }
          })
          .catch(() => updatePhoneStatus('Error al guardar el número.', true));
      });
    }
  })();
</script>
{% endblock %}
