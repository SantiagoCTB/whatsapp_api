{% extends 'base.html' %}
{% block title %}Configuración IA{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Configuración de IA</h2>
<div class="page-tabs">
    <a class="tab-link" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link active" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_signup') }}">Integraciones</a>
</div>

<p>Administra el token del modelo <strong>o4-mini</strong> y sube el catálogo en PDF o indica una URL desde donde descargarlo. Cada página del PDF se indexará con OCR y se guardará como imagen para poder adjuntarla en las respuestas. El procesamiento se ejecuta en segundo plano.</p>

{% if status_message %}
<div class="alert success">{{ status_message }}</div>
{% endif %}
{% if error_message %}
<div class="alert error">{{ error_message }}</div>
{% endif %}
{% if ia_config and ia_config.pdf_ingest_state %}
    {% if ia_config.pdf_ingest_state == 'running' %}
    <div class="alert success">
        El catálogo se está procesando en segundo plano.
        {% if ia_config.pdf_ingest_started_at %}
        <small>Inicio: {{ ia_config.pdf_ingest_started_at }}</small>
        {% endif %}
    </div>
    {% elif ia_config.pdf_ingest_state == 'succeeded' %}
    <div class="alert success">
        El catálogo terminó de procesarse.
        {% if ia_config.pdf_ingest_finished_at %}
        <small>Finalizado: {{ ia_config.pdf_ingest_finished_at }}</small>
        {% endif %}
    </div>
    {% elif ia_config.pdf_ingest_state == 'failed' %}
    <div class="alert error">
        Hubo un problema al procesar el catálogo.
        {% if ia_config.pdf_ingest_error %}
        <small>{{ ia_config.pdf_ingest_error }}</small>
        {% endif %}
    </div>
    {% endif %}
{% endif %}

<form class="card" method="POST" enctype="multipart/form-data">
    <div class="form-row">
        <label for="ia_model">Modelo</label>
        <input type="text" id="ia_model" name="ia_model" value="{{ ia_config.model_name if ia_config else 'o4-mini' }}" readonly>
    </div>
    <div class="form-row">
        <label for="ia_token">Token del modelo</label>
        <input type="text" id="ia_token" name="ia_token" value="{{ ia_config.model_token or '' if ia_config else '' }}" required>
    </div>
    <div class="form-row">
        <label for="system_prompt">Prompt de respuesta</label>
        <textarea id="system_prompt" name="system_prompt" rows="5" placeholder="Describe el tono, formato y límites de la respuesta de la IA.">{{ ia_config.system_prompt or '' if ia_config else '' }}</textarea>
        <small>Se usará como mensaje de sistema para definir el estilo de respuesta de la IA.</small>
    </div>
    <div class="form-row">
        <label for="business_description">Descripción del negocio</label>
        <textarea id="business_description" name="business_description" rows="4" placeholder="Describe qué hace tu negocio, productos o servicios, y el tipo de cliente al que atiendes.">{{ ia_config.business_description or '' if ia_config else '' }}</textarea>
        <small>Se añade como contexto para mejorar la detección del catálogo y las respuestas en ia_chat.</small>
    </div>
    <div class="form-row checkbox-row">
        <label for="ia_enabled" class="checkbox-label">
            <input type="checkbox" id="ia_enabled" name="ia_enabled" value="1" {% if ia_config is none or ia_config.enabled %}checked{% endif %}>
            Activar respuestas con IA
        </label>
        <small>Si desactivas la IA, no se mostrará el aviso en el chat hasta volver a habilitarla.</small>
    </div>
    <div class="form-row">
        <label for="catalogo_pdf">Catálogo PDF</label>
        <input type="file" id="catalogo_pdf" name="catalogo_pdf" accept="application/pdf">
        <small>Solo archivos PDF, máximo 15 MB.</small>
    </div>
    <div class="form-row">
        <label for="catalogo_url">o URL del catálogo</label>
        <input type="url" id="catalogo_url" name="catalogo_url" placeholder="https://.../catalogo.pdf" value="{{ ia_config.pdf_source_url or '' if ia_config else '' }}">
        <small>Se descargará y se indexará igual que un archivo subido.</small>
    </div>

    {% if ia_config and ia_config.pdf_filename %}
    <div class="form-row">
        <p class="muted">Archivo actual:</p>
        <ul class="file-meta">
            <li><strong>Nombre original:</strong> {{ ia_config.pdf_original_name or 'Desconocido' }}</li>
            <li><strong>Peso:</strong> {{ ia_config.pdf_size or '0' }} bytes</li>
            <li><strong>MIME:</strong> {{ ia_config.pdf_mime or 'application/pdf' }}</li>
            {% if ia_config.pdf_uploaded_at %}
            <li><strong>Subido:</strong> {{ ia_config.pdf_uploaded_at }}</li>
            {% endif %}
            {% if pdf_url %}
            <li><a href="{{ pdf_url }}" target="_blank" rel="noopener">Ver PDF</a></li>
            {% endif %}
            {% if ia_config.pdf_source_url %}
            <li><strong>Origen:</strong> <a href="{{ ia_config.pdf_source_url }}" target="_blank" rel="noopener">{{ ia_config.pdf_source_url }}</a></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}

    <button type="submit" class="btn-primary">Guardar configuración</button>
</form>
{% endblock %}
