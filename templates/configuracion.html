{% extends 'base.html' %}
{% block title %}Configuración de Reglas{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Configuración de Reglas</h2>
<div class="page-tabs">
    <a class="tab-link active" href="{{ url_for('configuracion.reglas') }}">Reglas</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_ia') }}">Configuración IA</a>
    <a class="tab-link" href="{{ url_for('configuracion.configuracion_signup') }}">Integraciones</a>
</div>
<p>Para reglas de medición usa "*" en <em>Texto del usuario</em> y define la fórmula en <em>Cálculo</em> con variables como <code>medida</code>, <code>p1</code> o <code>p2</code>. El comodín "*" permite avanzar al siguiente paso sin validar el texto recibido: si es la única regla del paso se ejecutará de forma automática; si hay más reglas, actuará como opción por defecto. Opcionalmente indica un <em>Handler</em> para delegar el cálculo a código externo.</p>

<form id="reglaForm" method="POST" enctype="multipart/form-data">
    <h3>Agregar o actualizar regla</h3>
    <input type="hidden" id="regla_id" name="regla_id">
    <label for="step">Paso actual:</label>
    <input type="text" id="step" name="step" required>

    <label for="input_text">Texto del usuario (separa sinónimos con comas):</label>
    <input type="text" id="input_text" name="input_text" placeholder="palabra1, palabra2" required>

    <label for="respuesta">Respuesta del bot:</label>
    <textarea id="respuesta" name="respuesta" rows="4"></textarea>

    <label for="siguiente_step">Siguiente paso (puedes ingresar varios pasos separados por comas):</label>
    <input type="text" id="siguiente_step" name="siguiente_step" placeholder="paso1, paso2">

    <label for="platform">Plataforma:</label>
    <select name="platform" id="platform" class="form-control">
        <option value="">Todas</option>
        <option value="whatsapp">WhatsApp</option>
        <option value="messenger">Messenger</option>
        <option value="instagram">Instagram</option>
    </select>

    <label for="tipo">Tipo:</label>
    <select name="tipo" id="tipo" class="form-control">
        <option value="texto">Texto</option>
        <option value="boton">Botón</option>
        <option value="lista">Lista</option>
        <option value="flow">Flow</option>
        <option value="image">Imagen</option>
        <option value="document">Documento</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
    </select>
    <p id="instagram-rule-warning" class="alert alert-warning" style="display:none;">
        Instagram solo acepta reglas de tipo texto o botón.
    </p>

    <label for="media" id="label_media_file" style="display:none;">Subir archivo:</label>
    <input type="file" id="media" name="media" style="display:none;">

    <label for="media_url" id="label_media_url" style="display:none;">o URL del archivo:</label>
    <input type="text" id="media_url" name="media_url" style="display:none;">

    <label for="rol_keyword">Rol keyword:</label>
    <input type="text" id="rol_keyword" name="rol_keyword">

    <label for="calculo">Cálculo:</label>
    <input type="text" id="calculo" name="calculo">

    <label for="handler">Handler externo:</label>
    <input type="text" id="handler" name="handler">

    <label for="list_header" class="list-field" style="display:none;">Encabezado de la lista:</label>
    <input type="text" id="list_header" name="list_header" class="list-field" style="display:none;">

    <label for="list_button" class="list-field" style="display:none;">Texto del botón:</label>
    <input type="text" id="list_button" name="list_button" class="list-field" style="display:none;">

    <label for="list_footer" class="list-field" style="display:none;">Pie de página (opcional):</label>
    <input type="text" id="list_footer" name="list_footer" class="list-field" style="display:none;">

    <div id="button_builder" class="button-field" style="display:none;">
        <label>Opciones del botón:</label>
        <div id="button_builder_list" class="builder-list"></div>
        <button type="button" class="btn-secondary" id="add_button_option">Agregar botón</button>
        <p id="button-platform-hint" class="helper-text" style="display:none;">
            Los botones de enlace solo están disponibles en Instagram/Messenger.
        </p>
    </div>
    <textarea id="button_options" name="button_options" class="button-field" style="display:none;"></textarea>
    <div id="instagram-button-help" class="alert alert-info" style="display:none;">
        <strong>Instagram:</strong> usa un arreglo JSON con hasta 3 botones. Puedes enviar botones de respuesta
        (<code>type: "postback"</code> con <code>title</code> y <code>payload</code>) o botones de enlace
        (<code>type: "web_url"</code> con <code>title</code> y <code>url</code>).
        <pre style="white-space: pre-wrap;">[
  {"type": "postback", "title": "Ver catálogo", "payload": "catalogo"},
  {"type": "web_url", "title": "Ir al sitio", "url": "https://tusitio.com"}
]</pre>
    </div>

    <div id="list_builder" class="list-field" style="display:none;">
        <label>Secciones de la lista:</label>
        <div id="sections_builder" class="builder-list"></div>
        <button type="button" class="btn-secondary" id="add_list_section">Agregar sección</button>
    </div>
    <textarea id="sections" name="sections" class="list-field" style="display:none;"></textarea>

    <div id="flow_fields" class="flow-field" style="display:none;">
        <h4>Configuración de Flow</h4>
        <label for="flow_cta">CTA:</label>
        <input type="text" id="flow_cta" name="flow_cta" placeholder="Ej. flow_cta">

        <label for="flow_id">ID del Flow:</label>
        <input type="text" id="flow_id" name="flow_id" placeholder="flow_id">

        <label for="flow_name">Nombre del Flow:</label>
        <input type="text" id="flow_name" name="flow_name" placeholder="Nombre legible">

        <label for="flow_version">Versión:</label>
        <input type="text" id="flow_version" name="flow_version" placeholder="Ej. 1.0">

        <label for="flow_mode">Modo:</label>
        <input type="text" id="flow_mode" name="flow_mode" placeholder="Ej. draft o live">

        <label for="flow_token">Token:</label>
        <input type="text" id="flow_token" name="flow_token" placeholder="Token opcional">

        <label for="flow_action">Acción:</label>
        <input type="text" id="flow_action" name="flow_action" placeholder="Acción del flow">

        <label for="flow_initial_screen">Pantalla inicial:</label>
        <input type="text" id="flow_initial_screen" name="flow_initial_screen" placeholder="ID de pantalla inicial">

        <label for="flow_data">Datos (JSON o texto):</label>
        <textarea id="flow_data" name="flow_data" rows="4" placeholder='{"variable":"valor"}'></textarea>

        <label for="flow_header">Encabezado (opcional):</label>
        <input type="text" id="flow_header" name="flow_header" placeholder="Encabezado del mensaje">

        <label for="flow_body">Cuerpo (opcional):</label>
        <textarea id="flow_body" name="flow_body" rows="3" placeholder="Descripción para el Flow"></textarea>

        <label for="flow_footer">Pie (opcional):</label>
        <input type="text" id="flow_footer" name="flow_footer" placeholder="Texto de pie">
    </div>
    <input type="hidden" name="opciones" id="opciones">

    <button type="submit" class="btn-primary">Guardar regla</button>
</form>

<form method="POST" enctype="multipart/form-data">
    <h3>Importar reglas desde archivo Excel (.xlsx)</h3>
    <input type="file" name="archivo" accept=".xlsx" required>
    <button type="submit" class="btn-primary">Importar reglas</button>
</form>

<h3>Reglas existentes</h3>
<table class="fixed-table">
    <tr>
        <th>ID</th>
        <th>Paso</th>
        <th>Input</th>
        <th>Respuesta</th>
        <th>Siguiente paso</th>
        <th>Plataforma</th>
        <th>Tipo</th>
        <th>Media URL</th>
        <th>Media Tipo</th>
        <th>Rol</th>
        <th>Opciones</th>
        <th>Encabezado</th>
        <th>Botón</th>
        <th>Pie</th>
        <th>Cálculo</th>
        <th>Handler</th>
        <th>Acción</th>
    </tr>
    {% for regla in reglas %}
    <tr>
        <td>{{ regla.id }}</td>
        <td>{{ regla.step }}</td>
        <td>{{ regla.input_text }}</td>
        <td>{{ regla.respuesta }}</td>
        <td>{{ regla.siguiente_step or '-' }}</td>
        <td>{{ regla.platform or 'Todas' }}</td>
        <td>{{ regla.tipo }}</td>
        <td><pre style="white-space: pre-wrap;">{{ regla.media_urls|join('\n') if regla.media_urls else '-' }}</pre></td>
        <td><pre style="white-space: pre-wrap;">{{ regla.media_tipos|join('\n') if regla.media_tipos else '-' }}</pre></td>
        <td>{{ regla.rol_keyword or '-' }}</td>
        <td>
            {% if regla.tipo == 'flow' and regla.flow %}
                <div><strong>CTA:</strong> {{ regla.flow.cta or '-' }}</div>
                <div><strong>ID:</strong> {{ regla.flow.flow_id or '-' }}</div>
                <div><strong>Nombre:</strong> {{ regla.flow.flow_name or '-' }}</div>
                <div><strong>Versión:</strong> {{ regla.flow.version or '-' }}</div>
                <div><strong>Modo:</strong> {{ regla.flow.mode or '-' }}</div>
                <div><strong>Acción:</strong> {{ regla.flow.action or '-' }}</div>
                <div><strong>Pantalla inicial:</strong> {{ regla.flow.initial_screen or '-' }}</div>
                {% if regla.flow.token %}
                <div><strong>Token:</strong> {{ regla.flow.token }}</div>
                {% endif %}
                {% if regla.flow.data_display %}
                <details>
                    <summary>Datos</summary>
                    <pre style="white-space: pre-wrap;">{{ regla.flow.data_display }}</pre>
                </details>
                {% endif %}
                {% if regla.flow.json_display %}
                <details>
                    <summary>JSON completo</summary>
                    <pre style="white-space: pre-wrap;">{{ regla.flow.json_display }}</pre>
                </details>
                {% endif %}
            {% else %}
                <pre style="white-space: pre-wrap;">{{ regla.opciones_pretty or regla.opciones }}</pre>
            {% endif %}
        </td>
        <td>{{ regla.header or '-' }}</td>
        <td>{{ regla.button or '-' }}</td>
        <td>{{ regla.footer or '-' }}</td>
        <td>{{ regla.calculo or '-' }}</td>
        <td>{{ regla.handler or '-' }}</td>
        <td class="action-cell">
            <form onsubmit="event.preventDefault();">
                <button class="edit-btn btn-primary" type="button" onclick='cargarRegla({{ regla|tojson }})'>Editar</button>
            </form>
            <form method="POST" action="{{ url_for('configuracion.eliminar_regla', regla_id=regla.id) }}">
                <button class="delete-btn btn-primary" type="submit">Eliminar</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>

<script>
function toggleMediaFields() {
    const tipo = document.getElementById('tipo').value;
    const show = ['image', 'video', 'audio', 'document'].includes(tipo);
    document.getElementById('media').style.display = show ? 'block' : 'none';
    document.getElementById('label_media_file').style.display = show ? 'block' : 'none';
    document.getElementById('media_url').style.display = show ? 'block' : 'none';
    document.getElementById('label_media_url').style.display = show ? 'block' : 'none';
}

function toggleListFields() {
    const isList = document.getElementById('tipo').value === 'lista';
    document.querySelectorAll('.list-field').forEach(el => {
        el.style.display = isList ? 'block' : 'none';
    });
}

function toggleButtonFields() {
    const isButton = document.getElementById('tipo').value === 'boton';
    document.querySelectorAll('.button-field').forEach(el => {
        el.style.display = isButton ? 'block' : 'none';
    });
}

function toggleFlowFields() {
    const isFlow = document.getElementById('tipo').value === 'flow';
    document.querySelectorAll('.flow-field').forEach(el => {
        el.style.display = isFlow ? 'block' : 'none';
    });
}

function toggleInstagramButtonHelp() {
    const tipo = document.getElementById('tipo').value;
    const platform = document.getElementById('platform').value;
    const help = document.getElementById('instagram-button-help');
    if (!help) return;
    help.style.display = platform === 'instagram' && tipo === 'boton' ? 'block' : 'none';
}

function allowUrlButtons() {
    const platform = document.getElementById('platform').value;
    return platform === 'instagram' || platform === 'messenger';
}

function syncButtonTypeOptions() {
    const allowUrl = allowUrlButtons();
    document.querySelectorAll('.button-type').forEach(select => {
        const urlOption = select.querySelector('option[value="web_url"]');
        if (urlOption) {
            urlOption.disabled = !allowUrl;
        }
        if (!allowUrl && select.value === 'web_url') {
            select.value = 'reply';
            updateButtonRowVisibility(select.closest('.builder-row'));
        }
    });
    const hint = document.getElementById('button-platform-hint');
    if (hint) {
        hint.style.display = allowUrl ? 'none' : 'block';
    }
}

function updateButtonRowVisibility(row) {
    if (!row) return;
    const type = row.querySelector('.button-type')?.value || 'reply';
    const urlField = row.querySelector('.button-url-field');
    const payloadField = row.querySelector('.button-payload-field');
    if (type === 'web_url') {
        if (urlField) urlField.style.display = 'block';
        if (payloadField) payloadField.style.display = 'none';
    } else {
        if (urlField) urlField.style.display = 'none';
        if (payloadField) payloadField.style.display = 'block';
    }
}

function createButtonRow(data = {}) {
    const row = document.createElement('div');
    row.className = 'builder-row';
    row.innerHTML = `
        <div class="builder-field">
            <label>Tipo</label>
            <select class="button-type">
                <option value="reply">Respuesta</option>
                <option value="web_url">Enlace (URL)</option>
            </select>
        </div>
        <div class="builder-field">
            <label>Título</label>
            <input type="text" class="button-title" placeholder="Texto del botón">
        </div>
        <div class="builder-field button-payload-field">
            <label>ID / Payload</label>
            <input type="text" class="button-payload" placeholder="identificador">
        </div>
        <div class="builder-field button-url-field" style="display:none;">
            <label>URL</label>
            <input type="url" class="button-url" placeholder="https://...">
        </div>
        <div class="builder-field">
            <label>Próximo paso (opcional)</label>
            <input type="text" class="button-step" placeholder="siguiente paso">
        </div>
        <div class="builder-actions">
            <button type="button" class="btn-secondary button-remove">Quitar</button>
        </div>
    `;
    row.querySelector('.button-type').value = data.type || 'reply';
    row.querySelector('.button-title').value = data.title || '';
    row.querySelector('.button-payload').value = data.payload || '';
    row.querySelector('.button-url').value = data.url || '';
    row.querySelector('.button-step').value = data.step || '';
    row.querySelector('.button-type').addEventListener('change', () => updateButtonRowVisibility(row));
    row.querySelector('.button-remove').addEventListener('click', () => row.remove());
    updateButtonRowVisibility(row);
    return row;
}

function addButtonOption(data = {}) {
    const list = document.getElementById('button_builder_list');
    if (!list) return;
    list.appendChild(createButtonRow(data));
    syncButtonTypeOptions();
}

function createListRow(data = {}) {
    const row = document.createElement('div');
    row.className = 'builder-row';
    row.innerHTML = `
        <div class="builder-field">
            <label>ID</label>
            <input type="text" class="row-id" placeholder="id_opcion">
        </div>
        <div class="builder-field">
            <label>Título</label>
            <input type="text" class="row-title" placeholder="Texto principal">
        </div>
        <div class="builder-field">
            <label>Descripción</label>
            <input type="text" class="row-description" placeholder="Opcional">
        </div>
        <div class="builder-field">
            <label>Próximo paso (opcional)</label>
            <input type="text" class="row-step" placeholder="siguiente paso">
        </div>
        <div class="builder-actions">
            <button type="button" class="btn-secondary row-remove">Quitar</button>
        </div>
    `;
    row.querySelector('.row-id').value = data.id || '';
    row.querySelector('.row-title').value = data.title || '';
    row.querySelector('.row-description').value = data.description || '';
    row.querySelector('.row-step').value = data.step || '';
    row.querySelector('.row-remove').addEventListener('click', () => row.remove());
    return row;
}

function createListSection(data = {}) {
    const section = document.createElement('div');
    section.className = 'builder-section';
    section.innerHTML = `
        <div class="builder-section-header">
            <div class="builder-field">
                <label>Título de sección</label>
                <input type="text" class="section-title" placeholder="Sección">
            </div>
            <div class="builder-actions">
                <button type="button" class="btn-secondary add-row">Agregar fila</button>
                <button type="button" class="btn-secondary remove-section">Quitar sección</button>
            </div>
        </div>
        <div class="section-rows"></div>
    `;
    section.querySelector('.section-title').value = data.title || '';
    const rowsContainer = section.querySelector('.section-rows');
    const rows = Array.isArray(data.rows) ? data.rows : [];
    if (rows.length) {
        rows.forEach(row => rowsContainer.appendChild(createListRow(row)));
    } else {
        rowsContainer.appendChild(createListRow());
    }
    section.querySelector('.add-row').addEventListener('click', () => {
        rowsContainer.appendChild(createListRow());
    });
    section.querySelector('.remove-section').addEventListener('click', () => section.remove());
    return section;
}

function addListSection(data = {}) {
    const list = document.getElementById('sections_builder');
    if (!list) return;
    list.appendChild(createListSection(data));
}

function collectButtons() {
    const rows = Array.from(document.querySelectorAll('#button_builder_list .builder-row'));
    const buttons = [];
    rows.forEach(row => {
        const type = row.querySelector('.button-type')?.value || 'reply';
        const title = row.querySelector('.button-title')?.value.trim();
        const payload = row.querySelector('.button-payload')?.value.trim();
        const url = row.querySelector('.button-url')?.value.trim();
        const step = row.querySelector('.button-step')?.value.trim();
        if (type === 'web_url') {
            if (!title && !url) return;
            if (!title || !url) {
                throw new Error('Todos los botones de enlace deben tener título y URL.');
            }
            const button = { type: 'web_url', title, url };
            if (step) button.step = step;
            buttons.push(button);
        } else {
            if (!title && !payload) return;
            if (!title || !payload) {
                throw new Error('Todos los botones de respuesta deben tener título e ID.');
            }
            const button = { type: 'reply', reply: { id: payload, title } };
            if (step) button.step = step;
            buttons.push(button);
        }
    });
    return buttons;
}

function collectSections() {
    const sections = [];
    document.querySelectorAll('#sections_builder .builder-section').forEach(section => {
        const title = section.querySelector('.section-title')?.value.trim();
        const rows = [];
        section.querySelectorAll('.section-rows .builder-row').forEach(row => {
            const id = row.querySelector('.row-id')?.value.trim();
            const rowTitle = row.querySelector('.row-title')?.value.trim();
            const description = row.querySelector('.row-description')?.value.trim();
            const step = row.querySelector('.row-step')?.value.trim();
            if (!id && !rowTitle && !description && !step) return;
            if (!id || !rowTitle) {
                throw new Error('Todas las filas deben tener ID y título.');
            }
            const rowData = { id, title: rowTitle };
            if (description) rowData.description = description;
            if (step) rowData.step = step;
            rows.push(rowData);
        });
        if (!title && rows.length === 0) return;
        sections.push({ title: title || 'Sección', rows });
    });
    return sections;
}

function parseOptions(raw) {
    if (!raw && raw !== 0) {
        return undefined;
    }
    if (typeof raw === 'object') {
        return raw;
    }
    if (typeof raw === 'string' && raw.trim() === '') {
        return undefined;
    }
    try {
        return JSON.parse(raw);
    } catch (err) {
        return raw;
    }
}

function prepareOptions(e) {
    const tipo = document.getElementById('tipo').value;
    const opcionesInput = document.getElementById('opciones');
    if (tipo === 'flow') {
        const cta = document.getElementById('flow_cta').value.trim();
        const flowId = document.getElementById('flow_id').value.trim();
        const flowName = document.getElementById('flow_name').value.trim();
        const version = document.getElementById('flow_version').value.trim();
        const mode = document.getElementById('flow_mode').value.trim();
        const token = document.getElementById('flow_token').value.trim();
        const action = document.getElementById('flow_action').value.trim();
        const initialScreen = document.getElementById('flow_initial_screen').value.trim();
        const dataRaw = document.getElementById('flow_data').value.trim();
        const header = document.getElementById('flow_header').value.trim();
        const body = document.getElementById('flow_body').value.trim();
        const footer = document.getElementById('flow_footer').value.trim();

        if (!cta) {
            alert('Debes ingresar el CTA del Flow.');
            e.preventDefault();
            return;
        }
        if (!flowId && !flowName) {
            alert('Debes ingresar el ID o el nombre del Flow.');
            e.preventDefault();
            return;
        }

        let dataValue = undefined;
        if (dataRaw) {
            try {
                dataValue = JSON.parse(dataRaw);
            } catch (err) {
                const looksJson = /^[\[{]/.test(dataRaw);
                if (looksJson) {
                    alert('El JSON de datos del Flow no es válido.');
                    e.preventDefault();
                    return;
                }
                dataValue = dataRaw;
            }
        }

        const flowOptions = { type: 'flow', cta };
        if (flowId) flowOptions.flow_id = flowId;
        if (flowName) flowOptions.flow_name = flowName;
        if (version) flowOptions.version = version;
        if (mode) flowOptions.mode = mode;
        if (token) flowOptions.token = token;
        if (action) flowOptions.action = action;
        if (initialScreen) flowOptions.initial_screen = initialScreen;
        if (dataValue !== undefined && dataValue !== '') flowOptions.data = dataValue;
        if (header) flowOptions.header = header;
        if (body) flowOptions.body = body;
        if (footer) flowOptions.footer = footer;

        opcionesInput.value = JSON.stringify(flowOptions);
    } else if (tipo === 'lista') {
        const header = document.getElementById('list_header').value;
        const button = document.getElementById('list_button').value;
        const footer = document.getElementById('list_footer').value;
        let sections = [];
        try {
            sections = collectSections();
        } catch (err) {
            alert(err.message || 'Hay un error en las secciones de la lista.');
            e.preventDefault();
            return;
        }
        const invalid = !Array.isArray(sections) || sections.length === 0 || sections.some(sec => !sec.rows || sec.rows.length === 0);
        if (invalid) {
            alert('Debes definir al menos una sección con una o más filas.');
            e.preventDefault();
            return;
        }
        document.getElementById('sections').value = JSON.stringify(sections);
        const opts = {header, button, footer, sections};
        opcionesInput.value = JSON.stringify(opts);
    } else if (tipo === 'boton') {
        let botones = [];
        try {
            botones = collectButtons();
        } catch (err) {
            alert(err.message || 'Hay un error en los botones.');
            e.preventDefault();
            return;
        }
        if (!botones.length) {
            alert('Debes agregar al menos un botón.');
            e.preventDefault();
            return;
        }
        document.getElementById('button_options').value = JSON.stringify(botones);
        opcionesInput.value = JSON.stringify(botones);
    } else {
        opcionesInput.value = '';
    }
}
document.getElementById('tipo').addEventListener('change', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    syncButtonTypeOptions();
});
document.getElementById('platform').addEventListener('change', () => {
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    syncButtonTypeOptions();
});
const instagramTokenPresent = {{ 'true' if instagram_token_present else 'false' }};
function toggleInstagramWarning() {
    const tipo = document.getElementById('tipo').value;
    const platform = document.getElementById('platform').value;
    const warning = document.getElementById('instagram-rule-warning');
    if (!warning) return;
    const platformApplies = platform === '' || platform === 'instagram';
    const show = instagramTokenPresent && platformApplies && !['texto', 'boton'].includes(tipo);
    warning.style.display = show ? 'block' : 'none';
}
const form = document.getElementById('reglaForm');
form.addEventListener('submit', prepareOptions);
window.addEventListener('DOMContentLoaded', () => {
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramWarning();
    toggleInstagramButtonHelp();
    syncButtonTypeOptions();
    const addButton = document.getElementById('add_button_option');
    if (addButton) {
        addButton.addEventListener('click', () => addButtonOption());
    }
    const addSection = document.getElementById('add_list_section');
    if (addSection) {
        addSection.addEventListener('click', () => addListSection());
    }
    if (document.getElementById('button_builder_list')?.children.length === 0) {
        addButtonOption();
    }
    if (document.getElementById('sections_builder')?.children.length === 0) {
        addListSection();
    }
});

function cargarRegla(regla) {
    document.getElementById('regla_id').value = regla.id;
    document.getElementById('step').value = regla.step || '';
    document.getElementById('input_text').value = regla.input_text || '';
    document.getElementById('respuesta').value = regla.respuesta || '';
    document.getElementById('siguiente_step').value = regla.siguiente_step || '';
    document.getElementById('platform').value = regla.platform || '';
    document.getElementById('tipo').value = regla.tipo || 'texto';
    document.getElementById('media').value = '';
    document.getElementById('media_url').value = (regla.media_urls || []).filter(u => u).join(', ');
    document.getElementById('rol_keyword').value = regla.rol_keyword || '';
    document.getElementById('calculo').value = regla.calculo || '';
    document.getElementById('handler').value = regla.handler || '';
    document.getElementById('list_header').value = regla.header || '';
    document.getElementById('list_button').value = regla.button || '';
    document.getElementById('list_footer').value = regla.footer || '';
    document.getElementById('sections').value = '';
    document.getElementById('button_options').value = '';
    document.getElementById('opciones').value = '';
    document.getElementById('flow_cta').value = '';
    document.getElementById('flow_id').value = '';
    document.getElementById('flow_name').value = '';
    document.getElementById('flow_version').value = '';
    document.getElementById('flow_mode').value = '';
    document.getElementById('flow_token').value = '';
    document.getElementById('flow_action').value = '';
    document.getElementById('flow_initial_screen').value = '';
    document.getElementById('flow_data').value = '';
    document.getElementById('flow_header').value = '';
    document.getElementById('flow_body').value = '';
    document.getElementById('flow_footer').value = '';
    const opcionesParsed = parseOptions(regla.opciones);
    if (regla.tipo === 'lista') {
        document.getElementById('sections_builder').innerHTML = '';
        if (opcionesParsed && typeof opcionesParsed === 'object') {
            document.getElementById('list_header').value = opcionesParsed.header || '';
            document.getElementById('list_button').value = opcionesParsed.button || '';
            document.getElementById('list_footer').value = opcionesParsed.footer || '';
            const sections = Array.isArray(opcionesParsed.sections) ? opcionesParsed.sections : [];
            if (sections.length) {
                sections.forEach(section => addListSection({
                    title: section.title || '',
                    rows: Array.isArray(section.rows) ? section.rows : [],
                }));
            } else {
                addListSection();
            }
            document.getElementById('sections').value = JSON.stringify(sections);
            document.getElementById('opciones').value = JSON.stringify(opcionesParsed);
        } else {
            addListSection();
            document.getElementById('sections').value = opcionesParsed || '';
            document.getElementById('opciones').value = opcionesParsed || '';
        }
    } else if (regla.tipo === 'boton') {
        document.getElementById('button_builder_list').innerHTML = '';
        const botones = Array.isArray(opcionesParsed) ? opcionesParsed : [];
        if (botones.length) {
            botones.forEach(option => {
                const type = (option.type || '').toLowerCase();
                const reply = option.reply || {};
                const isUrl = type === 'web_url' || option.url || option.link;
                if (isUrl) {
                    addButtonOption({
                        type: 'web_url',
                        title: option.title || option.text || '',
                        url: option.url || option.link || '',
                        step: option.step || option.next_step || '',
                    });
                } else {
                    addButtonOption({
                        type: 'reply',
                        title: option.title || option.text || reply.title || '',
                        payload: option.payload || option.id || reply.id || '',
                        step: option.step || option.next_step || '',
                    });
                }
            });
        } else {
            addButtonOption();
        }
        document.getElementById('button_options').value = JSON.stringify(botones);
        document.getElementById('opciones').value = typeof opcionesParsed === 'object' ? JSON.stringify(opcionesParsed) : (opcionesParsed || '');
    } else if (regla.tipo === 'flow') {
        document.getElementById('opciones').value = regla.opciones || '';
        if (regla.flow) {
            document.getElementById('flow_cta').value = regla.flow.cta || '';
            document.getElementById('flow_id').value = regla.flow.flow_id || '';
            document.getElementById('flow_name').value = regla.flow.flow_name || '';
            document.getElementById('flow_version').value = regla.flow.version || '';
            document.getElementById('flow_mode').value = regla.flow.mode || '';
            document.getElementById('flow_token').value = regla.flow.token || '';
            document.getElementById('flow_action').value = regla.flow.action || '';
            document.getElementById('flow_initial_screen').value = regla.flow.initial_screen || '';
            document.getElementById('flow_data').value = regla.flow.data_display || '';
            document.getElementById('flow_header').value = regla.flow.header || '';
            document.getElementById('flow_body').value = regla.flow.body || '';
            document.getElementById('flow_footer').value = regla.flow.footer || '';
        }
    } else {
        document.getElementById('opciones').value = regla.opciones || '';
    }
    toggleMediaFields();
    toggleListFields();
    toggleButtonFields();
    toggleFlowFields();
    toggleInstagramButtonHelp();
    syncButtonTypeOptions();
}
</script>
{% endblock %}
