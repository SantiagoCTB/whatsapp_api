{% extends 'base.html' %}
{% block title %}Respuestas{% endblock %}
{% block body_class %}page{% endblock %}
{% block content %}
<div class="top-right">
    <a href="{{ url_for('chat.index') }}">
        <button class="back-btn btn-primary">Volver al inicio</button>
    </a>
</div>

<h2>Respuestas</h2>
{% set max_summary_items = 10 %}
{% if flow_responses %}
<div class="flow-responses-table">
    <table class="fixed-table">
        <thead>
            <tr>
                <th>Número</th>
                <th>Fecha y hora</th>
                <th>Resumen del flow</th>
                <th>Respuesta del usuario</th>
                <th>Estado del asesor</th>
            </tr>
        </thead>
        <tbody>
            {% for resp in flow_responses %}
            <tr class="flow-response-row">
                <td class="flow-response-number">{{ resp.numero }}</td>
                <td class="flow-response-timestamp">
                    {% if resp.timestamp %}
                        {{ resp.timestamp.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td class="flow-response-summary">
                    <div class="flow-response-card">
                        {% if resp.flow_name %}
                            <p class="flow-text">{{ resp.flow_name }}</p>
                        {% endif %}
                        {% set summary = resp.summary or [] %}
                        {% set filtered = namespace(items=[]) %}
                        {% for item in summary %}
                            {% if item and item.label and 'flow_token' not in item.label|lower %}
                                {% set filtered.items = filtered.items + [item] %}
                            {% endif %}
                        {% endfor %}
                        {% set summary = filtered.items %}
                        {% if summary %}
                            <ul class="flow-summary">
                                {% for item in summary[:max_summary_items] %}
                                <li class="flow-summary-item">
                                    <span class="flow-summary-key">{{ item.label }}</span>
                                    <span class="flow-summary-value">{{ item.value }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                            {% if summary|length > max_summary_items %}
                                {% set remaining = summary|length - max_summary_items %}
                                <div class="flow-summary-more">+ {{ remaining }} dato{% if remaining != 1 %}s{% endif %} adicional{% if remaining != 1 %}es{% endif %}</div>
                            {% endif %}
                        {% elif resp.mensaje %}
                            <div class="flow-response-message">{{ resp.mensaje }}</div>
                        {% else %}
                            <div class="flow-response-message">Sin contenido</div>
                        {% endif %}
                    </div>
                </td>
                <td class="flow-response-user">
                    {% set segments = resp.segments or [] %}
                    {% if segments %}
                        {% set ns = namespace(first_text=True) %}
                        {% for segment in segments %}
                            {% if segment.kind == 'text' %}
                                <p class="flow-user-response">
                                    {% if ns.first_text %}
                                        <span class="flow-label">Usuario:</span>
                                        {% set ns.first_text = False %}
                                    {% endif %}
                                    {{ segment.content }}
                                </p>
                            {% elif segment.kind == 'data' %}
                                <div class="flow-response-card flow-response-inline flow-segments-card">
                                    {% set summary = segment.summary or [] %}
                                    {% set filtered_segments = namespace(items=[]) %}
                                    {% for item in summary %}
                                        {% if item and item.label and 'flow_token' not in item.label|lower %}
                                            {% set filtered_segments.items = filtered_segments.items + [item] %}
                                        {% endif %}
                                    {% endfor %}
                                    {% set summary = filtered_segments.items %}
                                    {% if summary %}
                                        <ul class="flow-summary">
                                            {% for item in summary[:max_summary_items] %}
                                            <li class="flow-summary-item">
                                                <span class="flow-summary-key">{{ item.label }}</span>
                                                <span class="flow-summary-value">{{ item.value }}</span>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                        {% if summary|length > max_summary_items %}
                                            {% set remaining = summary|length - max_summary_items %}
                                            <div class="flow-summary-more">+ {{ remaining }} dato{% if remaining != 1 %}s{% endif %} adicional{% if remaining != 1 %}es{% endif %}</div>
                                        {% endif %}
                                    {% elif segment.display %}
                                        {% set display_text = segment.display|trim %}
                                        {% if display_text and display_text not in ['{}', '[]'] %}
                                            <pre class="flow-json">{{ display_text }}</pre>
                                        {% endif %}
                                    {% else %}
                                        <div class="flow-response-message">Sin contenido</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% elif resp.user_message %}
                        <p class="flow-user-response"><span class="flow-label">Usuario:</span> {{ resp.user_message }}</p>
                    {% else %}
                        <span class="flow-empty">—</span>
                    {% endif %}
                </td>
                <td class="flow-response-status">
                    {% if resp.agent_replied %}
                        <span class="status-badge status-resolved">Respondido</span>
                        {% if resp.agent_reply_timestamp %}
                            <span class="status-time">{{ resp.agent_reply_timestamp.strftime('%d/%m/%Y %H:%M') }}</span>
                        {% endif %}
                    {% else %}
                        <span class="status-badge status-pending">Pendiente</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No hay respuestas de flows disponibles.</p>
{% endif %}
{% endblock %}
