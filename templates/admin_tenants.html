{% extends 'base.html' %}
{% block title %}Panel Super Admin{% endblock %}
{% block body_class %}admin-tenants{% endblock %}
{% block content %}
<div class="admin-page">
  <h1>Gestión de empresas (solo super admin)</h1>

  {% if error %}
  <div class="alert alert-error">{{ error }}</div>
  {% endif %}
  {% if message %}
  <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  <div class="admin-grid">
    <section class="card">
      <h2>Empresas registradas</h2>
      <table class="table">
        <thead>
          <tr>
            <th>Tenant</th>
            <th>Nombre</th>
            <th>Base de datos</th>
            <th>Host</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for tenant in tenants %}
          <tr>
            <td>{{ tenant.tenant_key }}</td>
            <td>{{ tenant.name }}</td>
            <td>{{ tenant.db_name }}</td>
            <td>{{ tenant.db_host }}:{{ tenant.db_port }}</td>
            <td class="actions">
              <a class="btn" href="{{ url_for('tenant_admin.dashboard', tenant=tenant.tenant_key) }}">Gestionar</a>
              <form method="post" action="{{ url_for('tenant_admin.delete_tenant', tenant_key=tenant.tenant_key) }}" onsubmit="return confirm('¿Eliminar el tenant {{ tenant.tenant_key }}?');">
                <button type="submit" class="btn danger">Eliminar</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5">No hay empresas registradas todavía.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="card">
      <h2>Registrar/actualizar empresa</h2>
      <form method="post" action="{{ url_for('tenant_admin.create_or_update_tenant') }}" class="form-grid">
        <label>Clave (tenant_key)
          <input name="tenant_key" required placeholder="mi_empresa" />
        </label>
        <label>Nombre público
          <input name="name" placeholder="Nombre de la empresa" />
        </label>
        <label>DB Host
          <input name="db_host" required placeholder="localhost" />
        </label>
        <label>DB Puerto
          <input name="db_port" type="number" min="1" max="65535" value="3306" />
        </label>
        <label>DB Nombre
          <input name="db_name" required placeholder="whatsapp_tenant" />
        </label>
        <label>DB Usuario
          <input name="db_user" required placeholder="root" />
        </label>
        <label>DB Password
          <input name="db_password" required type="password" />
        </label>
        <label>Metadata (JSON opcional)
          <textarea name="metadata" rows="3" placeholder='{"branding": "Acme"}'></textarea>
        </label>
        <label class="checkbox-inline">
          <input type="checkbox" name="ensure_schema" value="1" checked /> Crear/actualizar esquema aislado
        </label>
        <button type="submit" class="btn primary">Guardar empresa</button>
      </form>
    </section>
  </div>

  {% if selected_tenant %}
  <section class="card">
    <h2>Administrar {{ selected_tenant.name }} ({{ selected_tenant.tenant_key }})</h2>
    <div class="meta-grid">
      <div><strong>DB:</strong> {{ selected_tenant.db_name }} en {{ selected_tenant.db_host }}:{{ selected_tenant.db_port }}</div>
      <div><strong>Usuario BD:</strong> {{ selected_tenant.db_user }}</div>
      <div><strong>Metadata:</strong> {{ selected_tenant.metadata or '{}' }}</div>
    </div>

    <div class="admin-grid">
      <div>
        <h3>Usuarios y roles</h3>
        <table class="table">
          <thead><tr><th>Usuario</th><th>Roles</th></tr></thead>
          <tbody>
            {% for u in tenant_users %}
            <tr>
              <td>{{ u.username }}</td>
              <td>{{ u.roles or '—' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="2">Aún no hay usuarios en este tenant.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div>
        <h3>Crear/actualizar usuario</h3>
        <form method="post" action="{{ url_for('tenant_admin.create_tenant_user', tenant_key=selected_tenant.tenant_key) }}" class="form-grid">
          <label>Usuario
            <input name="username" required placeholder="admin" />
          </label>
          <label>Contraseña
            <input name="password" type="password" required />
          </label>
          <fieldset class="roles">
            <legend>Roles</legend>
            {% for role in tenant_roles %}
            <label class="checkbox-inline">
              <input type="checkbox" name="roles" value="{{ role.keyword }}" /> {{ role.name }} ({{ role.keyword }})
            </label>
            {% else %}
            <p>No hay roles definidos aún en este tenant.</p>
            {% endfor %}
          </fieldset>
          <button type="submit" class="btn primary">Guardar usuario</button>
        </form>
      </div>
      <div>
        <h3>Variables de entorno por empresa</h3>
        <form method="post" action="{{ url_for('tenant_admin.update_tenant_env', tenant_key=selected_tenant.tenant_key) }}" class="form-grid">
          <label>META_TOKEN
            <input name="META_TOKEN" value="{{ tenant_env.get('META_TOKEN','') }}" placeholder="token de Meta" />
          </label>
          <label>MESSENGER_TOKEN
            <input name="MESSENGER_TOKEN" value="{{ tenant_env.get('MESSENGER_TOKEN','') }}" placeholder="token de Messenger" />
          </label>
          <label>INSTAGRAM_TOKEN
            <input name="INSTAGRAM_TOKEN" value="{{ tenant_env.get('INSTAGRAM_TOKEN','') }}" placeholder="token de Instagram" />
          </label>
          <label>MESSENGER_PAGE_ID
            <input name="MESSENGER_PAGE_ID" value="{{ tenant_env.get('MESSENGER_PAGE_ID','') }}" placeholder="ID de la Page de Messenger" />
          </label>
          <label>MESSENGER_PAGE_ACCESS_TOKEN
            <input name="MESSENGER_PAGE_ACCESS_TOKEN" value="{{ tenant_env.get('MESSENGER_PAGE_ACCESS_TOKEN','') }}" placeholder="token de acceso de la Page" />
          </label>
          <label>INSTAGRAM_PAGE_ID
            <input name="INSTAGRAM_PAGE_ID" value="{{ tenant_env.get('INSTAGRAM_PAGE_ID','') }}" placeholder="ID de la Page de Instagram" />
          </label>
          <label>INSTAGRAM_PAGE_ACCESS_TOKEN
            <input name="INSTAGRAM_PAGE_ACCESS_TOKEN" value="{{ tenant_env.get('INSTAGRAM_PAGE_ACCESS_TOKEN','') }}" placeholder="token de acceso de la Page" />
          </label>
          <label>PAGE_ID
            <input name="PAGE_ID" value="{{ tenant_env.get('PAGE_ID','') }}" placeholder="ID de la Page" />
          </label>
          <label>PAGE_ACCESS_TOKEN
            <input name="PAGE_ACCESS_TOKEN" value="{{ tenant_env.get('PAGE_ACCESS_TOKEN','') }}" placeholder="token de acceso de la Page" />
          </label>
          <label>PLATFORM (messenger | instagram)
            <select name="PLATFORM">
              <option value="" {% if not tenant_env.get('PLATFORM') %}selected{% endif %}>Seleccionar</option>
              <option value="messenger" {% if tenant_env.get('PLATFORM') == 'messenger' %}selected{% endif %}>messenger</option>
              <option value="instagram" {% if tenant_env.get('PLATFORM') == 'instagram' %}selected{% endif %}>instagram</option>
            </select>
          </label>
          <label>LONG_LIVED_TOKEN
            <input name="LONG_LIVED_TOKEN" value="{{ tenant_env.get('LONG_LIVED_TOKEN','') }}" placeholder="token largo generado por Meta" />
          </label>
          <label>PHONE_NUMBER_ID
            <input name="PHONE_NUMBER_ID" value="{{ tenant_env.get('PHONE_NUMBER_ID','') }}" placeholder="630532376819353" />
          </label>
          <label>WABA_ID
            <input name="WABA_ID" value="{{ tenant_env.get('WABA_ID','') }}" placeholder="1234567890" />
          </label>
          <label>BUSINESS_ID
            <input name="BUSINESS_ID" value="{{ tenant_env.get('BUSINESS_ID','') }}" placeholder="ID del Business Manager" />
          </label>
          <label>SECRET_KEY
            <input name="SECRET_KEY" value="{{ tenant_env.get('SECRET_KEY','') }}" placeholder="my_secret_token" />
          </label>
          <label>VERIFY_TOKEN
            <input name="VERIFY_TOKEN" value="{{ tenant_env.get('VERIFY_TOKEN','') }}" placeholder="token de verificación" />
          </label>
          <label>MEDIA_ROOT
            <input name="MEDIA_ROOT" value="{{ tenant_env.get('MEDIA_ROOT','') }}" placeholder="/app/static/uploads" />
          </label>
          <label>SESSION_TIMEOUT_MESSAGE
            <textarea name="SESSION_TIMEOUT_MESSAGE" rows="2" placeholder="Mensaje al cerrar sesión por inactividad">{{ tenant_env.get('SESSION_TIMEOUT_MESSAGE','') }}</textarea>
          </label>
          <label>SESSION_TIMEOUT (segundos)
            <input type="number" min="60" name="SESSION_TIMEOUT" value="{{ tenant_env.get('SESSION_TIMEOUT','') }}" />
          </label>
          <label>IA_API_TOKEN
            <input name="IA_API_TOKEN" value="{{ tenant_env.get('IA_API_TOKEN','') }}" placeholder="Token del proveedor de IA" />
          </label>
          <label>IA_MODEL
            <input name="IA_MODEL" value="{{ tenant_env.get('IA_MODEL','') }}" placeholder="o4-mini" />
          </label>
          <label>IA_HISTORY_LIMIT
            <input type="number" min="1" name="IA_HISTORY_LIMIT" value="{{ tenant_env.get('IA_HISTORY_LIMIT','') }}" />
          </label>
          <label>IA_SYSTEM_MESSAGE
            <textarea name="IA_SYSTEM_MESSAGE" rows="3" placeholder="Mensaje de sistema para el modelo de IA">{{ tenant_env.get('IA_SYSTEM_MESSAGE','') }}</textarea>
          </label>
          <p class="help">
            Las credenciales de WhatsApp (PHONE_NUMBER_ID y META_TOKEN) se guardan por
            empresa; deja los campos vacíos solo si todavía no tienes los datos para
            este tenant. Ya no se comparten valores del <code>.env</code> entre
            empresas.
          </p>
          <button type="submit" class="btn primary">Guardar variables</button>
        </form>
      </div>
      <div>
        <h3>Integraciones</h3>
        <div class="meta-grid">
          <div><strong>WABA_ID:</strong> {{ tenant_env.get('WABA_ID') or '—' }}</div>
          <div><strong>BUSINESS_ID:</strong> {{ tenant_env.get('BUSINESS_ID') or '—' }}</div>
          <div><strong>Phone number:</strong> {{ tenant_env.get('PHONE_NUMBER_ID') or '—' }}</div>
          <div><strong>Token largo:</strong> {{ tenant_env.get('LONG_LIVED_TOKEN') or tenant_env.get('META_TOKEN') or '—' }}</div>
          <div><strong>Page ID (Messenger):</strong> {{ tenant_env.get('MESSENGER_PAGE_ID') or tenant_env.get('PAGE_ID') or '—' }}</div>
          <div><strong>Page ID (Instagram):</strong> {{ tenant_env.get('INSTAGRAM_PAGE_ID') or '—' }}</div>
          <div><strong>Plataforma legacy:</strong> {{ tenant_env.get('PLATFORM') or '—' }}</div>
          <div><strong>Page name (Messenger):</strong> {{ (selected_tenant.metadata.get('page_selection', {}).get('messenger', {}).get('page_name') if selected_tenant.metadata else None) or '—' }}</div>
          <div><strong>Page name (Instagram):</strong> {{ (selected_tenant.metadata.get('page_selection', {}).get('instagram', {}).get('page_name') if selected_tenant.metadata else None) or '—' }}</div>
          <div><strong>Business info:</strong> {{ (selected_tenant.metadata.get('whatsapp_business') if selected_tenant.metadata else {}) or '—' }}</div>
        </div>
        <p class="help">Usa el Embedded Signup para generar las credenciales directamente desde Meta y guardarlas en este tenant.</p>
        <button
          id="wa-signup-trigger"
          class="btn primary"
          data-config-code="{{ signup_config_code or '' }}"
          data-tenant="{{ selected_tenant.tenant_key }}"
          {% if not signup_config_code or not facebook_app_id %}disabled{% endif %}
        >
          Abrir Embedded Signup
        </button>
        {% if not signup_config_code %}
        <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar SIGNUP_FACEBOOK en el entorno.</p>
        {% endif %}
        {% if not facebook_app_id %}
        <p class="alert alert-error" style="margin-top: 0.5rem">Falta configurar FACEBOOK_APP_ID en el entorno.</p>
        {% endif %}
        <div id="wa-signup-status" class="help" style="margin-top: 0.5rem"></div>
      </div>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  const facebookSdkReady = new Promise((resolve, reject) => {
    const initSdk = () => {
      if (!window.FB) {
        reject(new Error('Facebook SDK no disponible'));
        return;
      }
      try {
        FB.init({
          appId: '{{ facebook_app_id or '' }}',
          cookie: true,
          xfbml: true,
          version: 'v20.0'
        });
        FB.AppEvents && FB.AppEvents.logPageView();
        resolve(FB);
      } catch (err) {
        console.warn('No se pudo inicializar el SDK de Facebook', err);
        reject(err);
      }
    };

    window.fbAsyncInit = initSdk;

    if (window.FB) {
      initSdk();
      return;
    }

    if (!document.getElementById('facebook-jssdk')) {
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    }
  });
</script>
<script>
  (function() {
    const trigger = document.getElementById('wa-signup-trigger');
    if (!trigger) return;

    const facebookAppId = '{{ facebook_app_id or '' }}';
    const configCode = trigger.dataset.configCode;
    const tenantKey = trigger.dataset.tenant;
    const statusBox = document.getElementById('wa-signup-status');

    const updateStatus = (message, isError) => {
      if (!statusBox) return;
      statusBox.textContent = message || '';
      statusBox.style.color = isError ? '#c0392b' : '#2c3e50';
    };

    function handleSignupMessage(event) {
      if (event.origin !== 'https://www.facebook.com') return;
      let data = event.data;
      if (typeof data === 'string') {
        try { data = JSON.parse(data); } catch (err) { return; }
      }

      if (!data || data.type !== 'WA_EMBEDDED_SIGNUP' || data.event !== 'FINISH') {
        return;
      }

      const payload = data.data || {};
      fetch(`/admin/tenants/${tenantKey}/signup`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
        .then((resp) => resp.json())
        .then((resp) => {
          if (resp.ok) {
            updateStatus(resp.message || 'Credenciales guardadas. Recarga la página para ver los cambios.');
            setTimeout(() => window.location.reload(), 1200);
          } else {
            updateStatus(resp.error || 'No se pudieron guardar las credenciales.', true);
          }
        })
        .catch(() => updateStatus('Error al enviar los datos del signup.', true));
    }

    window.addEventListener('message', handleSignupMessage);

    trigger.addEventListener('click', function() {
      if (!facebookAppId) {
        updateStatus('Falta configurar FACEBOOK_APP_ID.', true);
        return;
      }
      if (!configCode) {
        updateStatus('Falta configurar SIGNUP_FACEBOOK.', true);
        return;
      }

      facebookSdkReady.then((FB) => {
        if (!FB || !FB.login) {
          updateStatus('El SDK de Facebook no está listo. Revisa tu conexión y APP_ID.', true);
          return;
        }

        updateStatus('Abriendo el diálogo de Embedded Signup...');
        FB.login(
          function(response) {
            if (response && response.status === 'connected') {
              updateStatus('Sesión de Facebook detectada. Completa el cuadro de diálogo para continuar.');
            } else {
              updateStatus('No se pudo abrir el diálogo de Facebook. Verifica los permisos del navegador.', true);
            }
          },
          {
            config_id: configCode,
            response_type: 'code',
            override_default_response_type: true,
          },
        );
      }).catch(() => {
        const popupUrl = `https://www.facebook.com/v20.0/dialog/oauth?app_id=${encodeURIComponent(facebookAppId)}&config_id=${encodeURIComponent(configCode)}&state=${encodeURIComponent(tenantKey)}&redirect_uri=${encodeURIComponent(window.location.href)}`;
        const features = 'width=700,height=800,menubar=no,toolbar=no';
        window.open(popupUrl, 'wa_signup', features);
        updateStatus('Se abrió el flujo de Embedded Signup en una nueva ventana (modo respaldo).');
      });
    });
  })();
</script>
{% endblock %}
